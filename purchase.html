<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinPulse - Purchase</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script defer src="https://analytics.cabinliving.ca/script.js" data-website-id="bd58d7d8-2b00-44ae-8285-c76db6e383ad"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17117116213"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'AW-17117116213');
    </script>
    <!-- Clarity tracking code for https://cabinpulse.com -->
<script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "rzeoobm96j");
</script>
    <script type="application/ld+json">
        {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": "CabinPulse Remote Monitoring Device",
          "image": "https://cabinpulse.com/product.png",
          "description": "Monitor your cabin or remote property 24/7 with CabinPulse â€“ no WiFi needed! Get instant alerts for temperature, power outages, humidity & more.",
          "offers": {
            "@type": "AggregateOffer",
            "offerCount": 2,
            "lowPrice": 10,
            "highPrice": 14,
            "priceCurrency": "CAD",
            "priceValidUntil": "2026-05-30",
            "itemCondition": "https://schema.org/NewCondition",
            "availability": "https://schema.org/InStock",
            "seller": {
              "@type": "Organization",
              "name": "CabinPulse"
            }
          }
        }
        </script>
        
        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "BreadcrumbList",
          "itemListElement": [
            {
              "@type": "ListItem",
              "position": 1,
              "name": "Home",
              "item": "https://cabinpulse.com"
            },
            {
              "@type": "ListItem",
              "position": 2,
              "name": "Purchase",
              "item": "https://cabinpulse.com/purchase.html"
            }
          ]
        }
        </script>
        <script>(function(w,d,t,r,u){var f,n,i;w[u]=w[u]||[],f=function(){var o={ti:"97188751", enableAutoSpaTracking: true};o.q=w[u],w[u]=new UET(o),w[u].push("pageLoad")},n=d.createElement(t),n.src=r,n.async=1,n.onload=n.onreadystatechange=function(){var s=this.readyState;s&&s!=="loaded"&&s!=="complete"||(f(),n.onload=n.onreadystatechange=null)},i=d.getElementsByTagName(t)[0],i.parentNode.insertBefore(n,i)})(window,document,"script","//bat.bing.com/bat.js","uetq");</script>

        <!-- Meta Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '491964136205687');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=491964136205687&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <style>
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --cta-color: #ffffff;
            --accent-color: #0f3460;
            --highlight-color: #e94560;
            --text-color: #ffffff;
            --dark-text-color: #000000;
            --transition-duration: 0.5s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 25px;
        }

        /* Trust Banner */
        .trust-banner {
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.95) 0%, rgba(233, 69, 96, 0.1) 100%);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(233, 69, 96, 0.2);
            padding: 5px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .trust-banner-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 48px;
            flex-wrap: wrap;
        }

        .trust-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0.95;
        }

        .trust-item i {
            color: var(--highlight-color);
            font-size: 1rem;
        }

        /* Header */
        header {
            background-color: rgba(26, 26, 46, 0.98);
            backdrop-filter: blur(12px);
            padding: 20px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(233, 69, 96, 0.2);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-container img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }

        .logo-container h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Main Purchase Container */
        .purchase-wrapper {
            padding: 40px 0;
            min-height: calc(100vh - 200px);
        }

        .purchase-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        /* Purchase Form */
        .purchase-form {
            background: linear-gradient(135deg, var(--primary-color) 0%, rgba(15,52,96,0.8) 100%);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
            border: 2px solid rgba(233,69,96,0.3);
            position: relative;
            overflow: hidden;
        }

        .purchase-form::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(233,69,96,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            z-index: 0;
            pointer-events: none;
        }

        .purchase-form > * {
            position: relative;
            z-index: 1;
        }

        .form-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .form-header h2 {
            font-size: 1.8rem;
            color: var(--highlight-color);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .form-header i {
            font-size: 2.5rem;
        }

        /* Step Indicators */
        .step-indicators {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 40px;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .step-indicator.active {
            opacity: 1;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(233, 69, 96, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--highlight-color);
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-icon {
            background: var(--highlight-color);
            color: white;
            transform: scale(1.1);
        }

        .step-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Form Steps */
        .form-step {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .form-step.active {
            display: block;
            opacity: 1;
        }

        .step-content {
            margin-bottom: 32px;
        }

        .step-title {
            font-size: 1.8rem;
            color: var(--highlight-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            font-weight: 700;
            gap: 12px;
        }

        .step-description {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        /* Country/Option Selection */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .selection-option {
            background: rgba(15, 52, 96, 0.4);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .selection-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .selection-option:hover::before,
        .selection-option.selected::before {
            opacity: 1;
        }

        .selection-option:hover,
        .selection-option.selected {
            border-color: var(--highlight-color);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(233, 69, 96, 0.3);
        }

        .selection-option i {
            font-size: 3rem;
            color: var(--highlight-color);
            margin-bottom: 16px;
            display: block;
            position: relative;
            z-index: 1;
        }

        .option-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .option-description {
            font-size: 0.9rem;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }

        /* Make International option full-width and horizontal */
        .selection-option[data-country="INTL"] {
            grid-column: 1 / -1;
            padding: 16px 24px;
            opacity: 0.85;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 16px;
            text-align: left;
        }

        .selection-option[data-country="INTL"] i {
            font-size: 2rem;
            margin-bottom: 0;
            display: inline;
        }

        .selection-option[data-country="INTL"] .option-title {
            font-size: 1.2rem;
            margin-bottom: 0;
            display: inline;
        }

        .selection-option[data-country="INTL"] .option-description {
            font-size: 0.85rem;
            display: inline;
            margin-left: 8px;
        }

        .selection-option[data-country="INTL"]:hover,
        .selection-option[data-country="INTL"].selected {
            opacity: 1;
        }

        /* Shipping Options */
        .shipping-options {
            display: none;
            margin-top: 32px;
        }

        .shipping-options.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Loading State */
        .shipping-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .loader-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(233, 69, 96, 0.2);
            border-top: 4px solid var(--highlight-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loader-text {
            color: var(--text-color);
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0.9;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Shipping Options */
        .shipping-option {
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.4) 0%, rgba(233, 69, 96, 0.05) 100%);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .shipping-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .shipping-option:hover::before,
        .shipping-option.selected::before {
            opacity: 1;
        }

        .shipping-option:hover,
        .shipping-option.selected {
            border-color: var(--highlight-color);
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.6) 0%, rgba(233, 69, 96, 0.1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(233, 69, 96, 0.2);
        }

        .shipping-option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: var(--highlight-color);
            position: relative;
            z-index: 2;
        }

        .shipping-details {
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .shipping-name {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            text-align: left;
            justify-content: space-between;
            gap: 12px;
        }

        .shipping-provider {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shipping-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
            background: white;
            padding: 4px;
            border-radius: 8px;
        }

        .shipping-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--highlight-color);
            background: rgba(233, 69, 96, 0.1);
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid rgba(233, 69, 96, 0.3);
        }

        .shipping-estimate {
            font-size: 0.95rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shipping-estimate i {
            color: var(--highlight-color);
        }

        /* Form Inputs */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: var(--highlight-color);
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
            background: rgba(15, 52, 96, 0.3);
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--highlight-color);
            background: rgba(15, 52, 96, 0.5);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Validation Styles */
        .form-group input.invalid {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .validation-message {
            color: #ff4444;
            font-size: 0.8rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-error-message {
            color: #ff4444;
            padding: 10px;
            margin-top: 10px;
            background-color: rgba(255, 68, 68, 0.1);
            border-radius: 5px;
        }

        /* Info Box */
        .info-box {
            background: rgba(15, 52, 96, 0.5);
            border: 1px solid var(--highlight-color);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-box i {
            color: var(--highlight-color);
            font-size: 1.2rem;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .info-box p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0;
        }

        /* Buttons */
        .button-container {
            display: flex;
            gap: 16px;
            margin-top: 40px;
        }

        .btn {
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--highlight-color);
            color: white;
            flex: 2;
        }

        .btn-primary:hover:not(:disabled) {
            background: #ff5a7c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-primary:disabled {
            background: rgba(233, 69, 96, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border: 2px solid rgba(233, 69, 96, 0.5);
            flex: 1;
        }

        .btn-secondary:hover {
            border-color: var(--highlight-color);
            background: rgba(233, 69, 96, 0.1);
        }

        /* Loading State */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Compact Plan Summary */
        .plan-summary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, rgba(15, 52, 96, 0.8) 100%);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(233, 69, 96, 0.3);
            position: relative;
            overflow: hidden;
        }

        .plan-summary::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(233, 69, 96, 0.05) 0%, transparent 70%);
            transform: rotate(45deg);
            z-index: 0;
            pointer-events: none;
        }

        .plan-summary > * {
            position: relative;
            z-index: 1;
        }

        .plan-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .plan-summary-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .plan-summary-title h2 {
            font-size: 1.6rem;
            color: var(--highlight-color);
            margin: 0;
        }

        .plan-summary-title i {
            font-size: 1.8rem;
            color: var(--highlight-color);
        }

        .compact-product-image {
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
        }

        /* Plan Toggle - Compact Version */
        .compact-plan-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .compact-toggle {
            position: relative;
            display: flex;
            background: rgba(15,52,96,0.4);
            border-radius: 50px;
            padding: 4px;
            border: 2px solid rgba(233,69,96,0.3);
        }

        .compact-toggle-option {
            padding: 8px 16px;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
            z-index: 2;
            position: relative;
            white-space: nowrap;
        }

        .compact-toggle-option.active {
            opacity: 1;
            color: #fff;
        }

        .compact-toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: var(--highlight-color);
            border-radius: 40px;
            transition: transform 0.3s ease;
            z-index: 1;
        }

        .compact-toggle-slider.three-year {
            transform: translateX(100%);
        }

        .compact-savings-indicator {
            position: absolute;
            top: -6px;
            right: -12px;
            background: var(--highlight-color);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 700;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(233, 69, 96, 0.4);
            z-index: 3;
            animation: gentleWiggle 2s infinite ease-in-out;
        }

        .compact-savings-indicator.activated {
            animation: none;
            transform: scale(1.05);
        }

        @keyframes gentleWiggle {
            0% { transform: rotate(-3deg) scale(1); }
            50% { transform: rotate(3deg) scale(1.05); }
            100% { transform: rotate(-3deg) scale(1); }
        }

        /* Pricing Display - Horizontal Layout */
        .pricing-horizontal {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .price-main {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .price-large {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--cta-color);
            line-height: 1;
        }

        .price-period {
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .price-label-compact {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .device-fee-compact {
            background: linear-gradient(135deg, rgba(15,52,96,0.6), rgba(233,69,96,0.1));
            border: 1px solid rgba(233,69,96,0.3);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .device-fee-compact i {
            color: var(--highlight-color);
        }

        .device-fee-amount {
            font-weight: 600;
            color: var(--text-color);
        }

        /* Features List - Compact */
        .features-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
        }

        .feature-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(15, 52, 96, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid rgba(233, 69, 96, 0.2);
        }

        .feature-badge i {
            color: var(--highlight-color);
            font-size: 0.9rem;
        }

        /* Total Summary - Minimal */
        .total-summary {
            background: rgba(15, 52, 96, 0.3);
            border: 1px solid rgba(233, 69, 96, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 24px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .total-row:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--highlight-color);
        }

        .total-label {
            opacity: 0.8;
        }

        .total-amount {
            font-weight: 600;
        }

        /* Footer */
        footer {
            background-color: var(--secondary-color);
            text-align: center;
            padding: 32px 0;
            border-top: 1px solid rgba(233, 69, 96, 0.2);
        }

        /* Phone Input with Country Code */
        .phone-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .country-select {
            position: relative;
            min-width: 120px;
        }

        .country-select select {
            width: 100%;
            padding: 14px 36px 14px 14px;
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
            background: rgba(15, 52, 96, 0.3);
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            cursor: pointer;
            appearance: none;
        }

        .country-select select:focus {
            outline: none;
            border-color: var(--highlight-color);
            background: rgba(15, 52, 96, 0.5);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .country-select::after {
            content: '\f107';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--highlight-color);
            pointer-events: none;
        }

        .phone-input-wrapper input {
            flex: 1;
        }

        /* Referral Section */
        .referral-section {
            background: rgba(15, 52, 96, 0.3);
            border: 1px solid rgba(233, 69, 96, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 24px 0;
        }

        .referral-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .referral-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .referral-title i {
            color: var(--highlight-color);
            font-size: 1.2rem;
        }

        .referral-toggle {
            color: var(--highlight-color);
            font-size: 0.9rem;
            transition: transform 0.2s ease;
        }

        .referral-toggle.open {
            transform: rotate(180deg);
        }

        .referral-content {
            transform: scaleY(0);
            transform-origin: top;
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .referral-content.open {
            transform: scaleY(1);
            opacity: 1;
            height: auto;
        }

        .referral-content-padding {
            padding-top: 20px;
        }

        .referral-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .referral-input-wrapper input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
            background: rgba(15, 52, 96, 0.3);
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .referral-input-wrapper input:focus {
            outline: none;
            border-color: var(--highlight-color);
            background: rgba(15, 52, 96, 0.5);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .referral-input-wrapper input.valid {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .referral-input-wrapper input.invalid {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .referral-validate-btn {
            padding: 14px 24px;
            background: var(--highlight-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: 'Poppins', sans-serif;
        }

        .referral-validate-btn:hover:not(:disabled) {
            background: #ff5a7c;
            transform: translateY(-2px);
        }

        .referral-validate-btn:disabled {
            background: rgba(233, 69, 96, 0.5);
            cursor: not-allowed;
        }

        .referral-feedback {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .referral-feedback.show {
            display: flex;
        }

        .referral-feedback.success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }

        .referral-feedback.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .referral-feedback i {
            font-size: 1.1rem;
        }

        .referral-description {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-bottom: 16px;
        }

        .discount-notice {
            font-size: 0.85rem;
            opacity: 0.7;
            text-align: center;
            margin-top: 16px;
            padding: 12px;
            background: rgba(15, 52, 96, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(233, 69, 96, 0.1);
        }

        .discount-notice i {
            color: var(--highlight-color);
            margin-right: 6px;
        }

        /* Responsive Design */
        @media (max-width: 968px) {
            .plan-summary-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .pricing-horizontal {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 16px;
            }

            .features-compact {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .purchase-wrapper {
                padding: 24px 0;
            }

            .plan-summary,
            .purchase-form {
                padding: 24px;
                border-radius: 20px;
            }

            .plan-summary-title h2 {
                font-size: 1.4rem;
            }

            .price-large {
                font-size: 2rem;
            }

            .selection-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .selection-option {
                padding: 24px 20px;
            }

            .selection-option[data-country="INTL"] {
                flex-direction: row;
                padding: 16px 20px;
            }

            .step-indicators {
                gap: 16px;
            }

            .step-icon {
                width: 40px;
                height: 40px;
                font-size: 0.8rem;
            }

            .button-container {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .trust-banner-content {
                gap: 12px;
                text-align: center;
            }

            .features-compact {
                gap: 8px;
            }

            .feature-badge {
                font-size: 0.75rem;
                padding: 4px 8px;
            }

            .shipping-option {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .shipping-name {
                flex-direction: column;
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .compact-toggle {
                width: 100%;
            }

            .compact-toggle-option {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .compact-savings-indicator {
                font-size: 0.55rem;
                padding: 2px 4px;
            }

            .plan-summary-title {
                flex-direction: column;
                gap: 8px;
            }

            .plan-summary-title h2 {
                font-size: 1.2rem;
            }

            .pricing-horizontal {
                gap: 12px;
            }

            .device-fee-compact {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .phone-input-wrapper {
                flex-direction: column;
                gap: 12px;
            }

            .country-select {
                width: 100%;
            }

            .referral-input-wrapper {
                flex-direction: column;
            }
            
            .referral-validate-btn {
                width: 100%;
            }

            .selection-option[data-country="INTL"] {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* International Shipping Modal */
        .intl-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .intl-modal.visible {
            display: flex;
        }

        .intl-modal-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: 2px solid var(--highlight-color);
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(233, 69, 96, 0.3);
            animation: slideUp 0.4s ease;
            position: relative;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .intl-modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(233, 69, 96, 0.3);
        }

        .intl-modal-icon {
            font-size: 2.5rem;
            color: var(--highlight-color);
        }

        .intl-modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .intl-modal-body {
            margin-bottom: 32px;
        }

        .intl-modal-body p {
            margin-bottom: 16px;
            line-height: 1.8;
            font-size: 1rem;
        }

        .intl-modal-body strong {
            color: var(--highlight-color);
        }

        .intl-device-highlight {
            background: rgba(233, 69, 96, 0.1);
            border-left: 4px solid var(--highlight-color);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .intl-device-highlight h3 {
            color: var(--highlight-color);
            margin-bottom: 12px;
            font-size: 1.3rem;
        }

        .intl-support-info {
            background: rgba(15, 52, 96, 0.4);
            border: 1px solid rgba(233, 69, 96, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .intl-support-info i {
            color: var(--highlight-color);
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .intl-modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .intl-modal-btn {
            background: linear-gradient(135deg, var(--highlight-color) 0%, #c93756 100%);
            color: var(--text-color);
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .intl-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
        }

        .intl-modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .intl-modal-btn:disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .intl-modal-screen {
            display: none;
        }

        .intl-modal-screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .intl-country-select {
            width: 100%;
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.6) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }

        .intl-country-select:hover {
            border-color: var(--highlight-color);
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.8) 0%, rgba(26, 26, 46, 0.8) 100%);
        }

        .intl-country-select:focus {
            outline: none;
            border-color: var(--highlight-color);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .intl-country-select option {
            background: rgba(26, 26, 46, 0.95);
            color: var(--text-color);
            padding: 8px;
        }

        .intl-country-select optgroup {
            font-weight: 600;
            color: var(--highlight-color);
        }

        /* Quantity Selector */
        .quantity-selector {
            background: rgba(15, 52, 96, 0.3);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .quantity-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .quantity-label-main {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .quantity-label-sub {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .quantity-btn {
            background: linear-gradient(135deg, var(--highlight-color) 0%, #c93756 100%);
            border: none;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }

        .quantity-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .quantity-input {
            background: rgba(15, 52, 96, 0.4);
            border: 2px solid rgba(233, 69, 96, 0.3);
            color: var(--text-color);
            font-size: 1.2rem;
            font-weight: 600;
            width: 80px;
            height: 40px;
            text-align: center;
            border-radius: 12px;
            padding: 8px;
        }

        .quantity-input:focus {
            outline: none;
            border-color: var(--highlight-color);
        }

        /* Hide number input arrows */
        .quantity-input::-webkit-inner-spin-button,
        .quantity-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-input[type=number] {
            -moz-appearance: textfield;
        }

        @media (max-width: 768px) {
            .intl-modal-content {
                padding: 24px;
                width: 95%;
            }

            .intl-modal-title {
                font-size: 1.4rem;
            }

            .intl-modal-icon {
                font-size: 2rem;
            }

            .intl-modal-body p {
                font-size: 0.95rem;
            }

            .quantity-selector {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .quantity-label {
                text-align: center;
            }

            .quantity-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Trust Banner -->
    <div class="trust-banner">
        <div class="trust-banner-content">
            <div class="trust-item">
                <i class="fas fa-undo"></i>
                <span>Free Returns</span>
            </div>
            <div class="trust-item">
                <i class="fas fa-check-circle"></i>
                <span>3-Year Warranty</span>
            </div>
            <div class="trust-item">
                <i class="fas fa-star"></i>
                <span>5-Star Support</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo-container">
                <a href="https://cabinpulse.com" style="display: flex; align-items: center; text-decoration: none;">
                    <img src="cpicon.png" alt="CabinPulse Logo">
                    <h1>CabinPulse</h1>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="purchase-wrapper">
        <div class="container">
            <div class="purchase-container">
                <!-- Purchase Form -->
                <div class="purchase-form">
                    <div class="form-header">
                        <h2>
                            <i class="fas fa-shopping-cart"></i>
                            Get CabinPulse
                        </h2>
                    </div>

                    <!-- Step Indicators -->
                    <div class="step-indicators">
                        <div class="step-indicator active" id="indicator-1">
                            <div class="step-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="step-label">Shipping</div>
                        </div>
                        <div class="step-indicator" id="indicator-2">
                            <div class="step-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="step-label">Account</div>
                        </div>
                        <div class="step-indicator" id="indicator-3">
                            <div class="step-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="step-label">Confirm</div>
                        </div>
                    </div>

                    <!-- Form Steps -->
                    <form id="purchaseForm">
                        <!-- Step 1: Shipping -->
                        <div class="form-step active" id="step-1">
                            <div class="step-content">
                                <div class="step-title">
                                    <i class="fas fa-globe"></i>
                                    Shipping
                                </div>
                                <div class="step-description">
                                    Choose your country to see available shipping options and delivery estimates.
                                </div>

                                <div class="selection-grid">
                                    <div class="selection-option" data-country="CA">
                                        <i class="fa-brands fa-canadian-maple-leaf"></i>
                                        <div class="option-title">Canada</div>
                                        <div class="option-description">Free shipping via Canada Post</div>
                                    </div>
                                    <div class="selection-option" data-country="US">
                                        <i class="fas fa-flag-usa"></i>
                                        <div class="option-title">United States</div>
                                        <div class="option-description">Free shipping via Canada Post / USPS</div>
                                    </div>
                                    <div class="selection-option" data-country="INTL">
                                        <i class="fas fa-globe-americas"></i>
                                        <div class="option-title">International</div>
                                        <div class="option-description">Worldwide shipping available</div>
                                    </div>
                                </div>

                                <!-- Shipping Options (Hidden by default) -->
                                <div class="shipping-options" id="shipping-options">
                                    <h3 style="color: var(--highlight-color); margin-bottom: 20px;">Choose Shipping Method:</h3>
                                    <div id="shipping-options-container">
                                        <!-- Shipping options will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <div class="button-container">
                                <button type="button" class="btn btn-primary" id="step1-continue" onclick="nextStep()" disabled>
                                    Continue
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Account -->
                        <div class="form-step" id="step-2">
                            <div class="step-content">
                                <div class="step-title">
                                    <i class="fas fa-user"></i>
                                    Account Setup
                                </div>
                                <div class="step-description">
                                    Do you have an existing CabinPulse account?
                                </div>

                                <div class="selection-grid">
                                    <div class="selection-option" data-type="new">
                                        <i class="fas fa-user-plus"></i>
                                        <div class="option-title">New Customer</div>
                                        <div class="option-description">This is my first CabinPulse device</div>
                                    </div>
                                    <div class="selection-option" data-type="existing">
                                        <i class="fas fa-sign-in-alt"></i>
                                        <div class="option-title">Existing Customer</div>
                                        <div class="option-description">I already have a CabinPulse account</div>
                                    </div>
                                </div>

                                <!-- New User Form -->
                                <div id="new-user-form" class="account-form" style="display: none;">
                                    <div class="info-box">
                                        <i class="fas fa-info-circle"></i>
                                        <p>Welcome! We'll send you an email with your login credentials once your purchase is complete.</p>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="name">
                                            <i class="fas fa-user"></i>
                                            Full Name
                                        </label>
                                        <input type="text" id="name" name="name" placeholder="John Doe" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="email">
                                            <i class="fas fa-envelope"></i>
                                            Email Address
                                        </label>
                                        <input type="email" id="email" name="email" placeholder="hello@website.com" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="phone">
                                            <i class="fas fa-mobile-alt"></i>
                                            Mobile Number for Alerts
                                        </label>
                                        <div class="phone-input-wrapper">
                                            <div class="country-select">
                                                <select id="phone-country" name="phone-country">
                                                    <option value="CA" data-code="+1">ðŸ‡¨ðŸ‡¦ +1</option>
                                                    <option value="US" data-code="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                                    <option value="AU" data-code="+61">ðŸ‡¦ðŸ‡º +61</option>
                                                    <option value="NZ" data-code="+64">ðŸ‡³ðŸ‡¿ +64</option>
                                                    <option value="VN" data-code="+84">ðŸ‡»ðŸ‡³ +84</option>
                                                </select>
                                            </div>
                                            <input type="tel" id="phone" name="phone" placeholder="0001234567" required>
                                        </div>
                                        <div class="info-box" style="margin-top: 12px;">
                                            <i class="fas fa-bell"></i>
                                            <p>You'll receive text alerts about your property's status. Alert preferences can be customized anytime.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Existing User Form -->
                                <div id="existing-user-form" class="account-form" style="display: none;">
                                    <div class="form-group">
                                        <label for="login-email">
                                            <i class="fas fa-envelope"></i>
                                            Email Address
                                        </label>
                                        <input type="email" id="login-email" name="login-email" placeholder="hello@website.com" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="login-password">
                                            <i class="fas fa-lock"></i>
                                            Password
                                        </label>
                                        <input type="password" id="login-password" name="login-password" placeholder="**********" required>
                                    </div>
                                </div>
                            </div>

                            <div class="button-container">
                                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                    <i class="fas fa-arrow-left"></i>
                                    Back
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep()">
                                    Continue
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Confirmation -->
                        <div class="form-step" id="step-3">
                            <div class="step-content">
                                <div class="step-title">
                                    <i class="fas fa-check-circle"></i>
                                    Review
                                </div>
                                <div class="step-description">
                                    Review your plan selection and complete your purchase. You can still change your plan below.
                                </div>

                                <!-- Compact Plan Summary -->
                                <div class="plan-summary">
                                    <div class="plan-summary-header">
                                        <div class="plan-summary-title">
                                            <img src="front.png" alt="CabinPulse Device" class="compact-product-image">
                                            <div>
                                                <h2>CabinPulse Monitoring</h2>
                                                <div class="price-label-compact" id="confirm-plan-duration">1-Year Plan</div>
                                            </div>
                                        </div>

                                        <!-- Compact Plan Toggle -->
                                        <div class="compact-plan-toggle">
                                            <div class="compact-toggle">
                                                <div class="compact-toggle-option active" data-plan="1" id="confirm-toggle-1">1 Year</div>
                                                <div class="compact-toggle-option" data-plan="3" id="confirm-toggle-3">
                                                    3 Years
                                                    <span class="compact-savings-indicator" id="confirm-savings-indicator">Save 29%!</span>
                                                </div>
                                                <div class="compact-toggle-slider" id="confirm-toggle-slider"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quantity Selector -->
                                    <div class="quantity-selector">
                                        <div class="quantity-label">
                                            <span class="quantity-label-main">Number of Units</span>
                                            <span class="quantity-label-sub" id="quantity-sub-label">Select quantity</span>
                                        </div>
                                        <div id="quantity-controls-wrapper">
                                            <div class="quantity-controls">
                                                <button type="button" class="quantity-btn" id="quantity-decrease">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" class="quantity-input" id="quantity-input" value="1" min="1" max="25">
                                                <button type="button" class="quantity-btn" id="quantity-increase">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Horizontal Pricing Layout -->
                                    <div class="pricing-horizontal">
                                        <div class="price-main">
                                            <div class="price-large">
                                                $<span id="confirm-monthly-price">14</span><span class="price-period">/mo</span>
                                            </div>
                                            <div class="price-label-compact" id="confirm-price-label">billed annually</div>
                                        </div>
                                        
                                        <div class="device-fee-compact">
                                            <i class="fas fa-plus"></i>
                                            <span>$199 CAD device fee</span>
                                        </div>
                                    </div>

                                    <!-- Compact Features -->
                                    <div class="features-compact">
                                        <div class="feature-badge">
                                            <i class="fas fa-wifi"></i>
                                            <span>No WiFi Required</span>
                                        </div>
                                        <div class="feature-badge">
                                            <i class="fas fa-bell"></i>
                                            <span>Instant Alerts</span>
                                        </div>
                                        <div class="feature-badge">
                                            <i class="fas fa-shield-alt"></i>
                                            <span>30-Day Guarantee</span>
                                        </div>
                                    </div>

                                    <!-- Total Summary -->
                                    <div class="total-summary">
                                        <div class="total-row">
                                            <span class="total-label">Subscription</span>
                                            <span class="total-amount" id="confirm-subscription-cost">$168/year</span>
                                        </div>
                                        <div class="total-row">
                                            <span class="total-label">Device Fee</span>
                                            <span class="total-amount" id="confirm-device-fee">$199 CAD</span>
                                        </div>
                                        <div class="total-row" id="confirm-shipping-summary-row" style="display: none;">
                                            <span class="total-label">Shipping</span>
                                            <span class="total-amount" id="confirm-shipping-cost">FREE</span>
                                        </div>
                                        <div class="total-row" id="confirm-tariff-summary-row" style="display: none;">
                                            <span class="total-label">US Import Tariff</span>
                                            <span class="total-amount" id="confirm-tariff-cost">$90 CAD</span>
                                        </div>
                                        <div class="total-row">
                                            <span>Total Due Today</span>
                                            <span id="confirm-total-due">$367 CAD</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Referral Code Section -->
                                <div class="referral-section">
                                    <div class="referral-header" id="referral-header">
                                        <div class="referral-title">
                                            <i class="fas fa-tag"></i>
                                            <span>Have a referral code?</span>
                                        </div>
                                        <i class="fas fa-chevron-down referral-toggle" id="referral-toggle"></i>
                                    </div>
                                    <div class="referral-content" id="referral-content">
                                        <div class="referral-content-padding">
                                            <p class="referral-description">Enter referral code below.</p>
                                            <div class="referral-input-wrapper">
                                                <input 
                                                    type="text" 
                                                    id="referral-code" 
                                                    placeholder="Enter code (e.g., ABC123)"
                                                    maxlength="10"
                                                >
                                                <button type="button" class="referral-validate-btn" id="validate-referral-btn">
                                                    Apply
                                                </button>
                                            </div>
                                            <div class="referral-feedback" id="referral-feedback">
                                                <i class="fas fa-circle-check"></i>
                                                <span id="referral-feedback-text"></span>
                                            </div>
                                            
                                            <!-- Discount Code Notice -->
                                            <div class="discount-notice">
                                                <i class="fas fa-ticket"></i>
                                                Have a discount code instead? You'll be able to apply it on the next screen.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-box">
                                    <i class="fas fa-info-circle"></i>
                                    <p>You can choose whether to renew when your plan ends - you won't be charged automatically. We'll send you a reminder before your renewal date.</p>
                                </div>
                            </div>

                            <div class="button-container">
                                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                    <i class="fas fa-arrow-left"></i>
                                    Back
                                </button>
                                <button type="submit" class="btn btn-primary" id="payment-button">
                                    <i class="fas fa-lock"></i>
                                    Complete Purchase
                                </button>
                            </div>
                            <p style="font-size: 0.9rem; opacity: 0.8; text-align: center; margin-top: 24px;">
                                By clicking "Complete Purchase", you agree to our 
                                <a href="https://cabinpulse.com/legal.html" style="color: var(--highlight-color);">Terms of Service</a> 
                                and 
                                <a href="https://cabinpulse.com/legal.html" style="color: var(--highlight-color);">Privacy Policy</a>.
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 CabinPulse</p>
        </div>
    </footer>

    <!-- International Shipping Modal -->
    <div id="intl-modal" class="intl-modal">
        <div class="intl-modal-content">
            <!-- Screen 1: Region Selection -->
            <div id="intl-modal-screen-1" class="intl-modal-screen active">
                <div class="intl-modal-header">
                    <i class="fas fa-globe intl-modal-icon"></i>
                    <h2 class="intl-modal-title">Select Your Country</h2>
                </div>

                <div class="intl-modal-body">
                    <p style="margin-bottom: 24px;">Please select your country to continue:</p>

                    <select class="intl-country-select" id="intl-country-select">
                        <option value="">Choose your country...</option>

                        <optgroup label="North America">
                            <option value="CA">Canada</option>
                            <option value="US">United States</option>
                            <option value="MX">Mexico</option>
                        </optgroup>

                        <optgroup label="Central America & Caribbean">
                            <option value="BZ">Belize</option>
                            <option value="CR">Costa Rica</option>
                            <option value="SV">El Salvador</option>
                            <option value="GT">Guatemala</option>
                            <option value="HN">Honduras</option>
                            <option value="NI">Nicaragua</option>
                            <option value="PA">Panama</option>
                        </optgroup>

                        <optgroup label="South America">
                            <option value="AR">Argentina</option>
                            <option value="BO">Bolivia</option>
                            <option value="BR">Brazil</option>
                            <option value="CL">Chile</option>
                            <option value="CO">Colombia</option>
                            <option value="EC">Ecuador</option>
                            <option value="GY">Guyana</option>
                            <option value="PY">Paraguay</option>
                            <option value="PE">Peru</option>
                            <option value="SR">Suriname</option>
                            <option value="UY">Uruguay</option>
                            <option value="VE">Venezuela</option>
                        </optgroup>

                        <optgroup label="Europe">
                            <option value="AT">Austria</option>
                            <option value="BE">Belgium</option>
                            <option value="CZ">Czech Republic</option>
                            <option value="DK">Denmark</option>
                            <option value="FI">Finland</option>
                            <option value="FR">France</option>
                            <option value="DE">Germany</option>
                            <option value="IE">Ireland</option>
                            <option value="IT">Italy</option>
                            <option value="NL">Netherlands</option>
                            <option value="NO">Norway</option>
                            <option value="PL">Poland</option>
                            <option value="PT">Portugal</option>
                            <option value="ES">Spain</option>
                            <option value="SE">Sweden</option>
                            <option value="CH">Switzerland</option>
                            <option value="GB">United Kingdom</option>
                        </optgroup>

                        <optgroup label="Asia">
                            <option value="HK">Hong Kong</option>
                            <option value="JP">Japan</option>
                            <option value="MY">Malaysia</option>
                            <option value="SG">Singapore</option>
                            <option value="KR">South Korea</option>
                            <option value="TW">Taiwan</option>
                            <option value="TH">Thailand</option>
                        </optgroup>

                        <optgroup label="Middle East">
                            <option value="AE">United Arab Emirates</option>
                        </optgroup>

                        <optgroup label="Oceania">
                            <option value="AU">Australia</option>
                            <option value="NZ">New Zealand</option>
                        </optgroup>

                        <optgroup label="Africa">
                            <option value="ZA">South Africa</option>
                        </optgroup>
                    </select>

                    <p style="margin-top: 16px; font-size: 0.9rem; opacity: 0.8;">
                        Don't see your country? Contact <a href="mailto:support@cabinpulse.com" style="color: var(--highlight-color); text-decoration: none;">support@cabinpulse.com</a>
                    </p>
                </div>
            </div>

            <!-- Screen 2a: Americas Information -->
            <div id="intl-modal-screen-2a" class="intl-modal-screen">
                <div class="intl-modal-header">
                    <i class="fas fa-earth-americas intl-modal-icon"></i>
                    <h2 class="intl-modal-title">Americas Shipping</h2>
                </div>

                <div class="intl-modal-body">
                    <p>Thank you for your interest in CabinPulse! For shipments to North, Central, and South America, we ship the standard <strong>CabinPulse</strong> device.</p>

                    <div class="intl-device-highlight">
                        <h3>CabinPulse Device</h3>
                        <p>The standard CabinPulse device works throughout the Americas region with full cellular connectivity and all monitoring features.</p>
                    </div>

                    <div class="intl-support-info">
                        <i class="fas fa-question-circle"></i>
                        <div>
                            <p style="margin: 0;"><strong>Questions about coverage in your country?</strong></p>
                            <p style="margin: 4px 0 0 0;">Please contact our customer service team at <a href="mailto:support@cabinpulse.com" style="color: var(--highlight-color); text-decoration: none;">support@cabinpulse.com</a> to confirm compatibility and coverage in your specific location.</p>
                        </div>
                    </div>
                </div>

                <div class="intl-modal-footer" style="justify-content: space-between;">
                    <button id="intl-modal-back-2a" class="intl-modal-btn" style="background: linear-gradient(135deg, rgba(15, 52, 96, 0.6) 0%, rgba(233, 69, 96, 0.3) 100%);">Back</button>
                    <button id="intl-modal-next-2a" class="intl-modal-btn">Next</button>
                </div>
            </div>

            <!-- Screen 2b: Rest of World - CabinPulse Global Information -->
            <div id="intl-modal-screen-2b" class="intl-modal-screen">
                <div class="intl-modal-header">
                    <i class="fas fa-globe-asia intl-modal-icon"></i>
                    <h2 class="intl-modal-title">International Shipping</h2>
                </div>

                <div class="intl-modal-body">
                    <p>Thank you for your interest in CabinPulse! For international orders outside the Americas, we ship the <strong>CabinPulse Global</strong> device.</p>

                    <div class="intl-device-highlight">
                        <h3>CabinPulse Global</h3>
                        <p>The CabinPulse Global is functionally identical to the standard CabinPulse device, with one key difference: it uses a different cellular modem specifically designed for international networks.</p>
                        <ul style="margin-left: 20px; margin-top: 12px; line-height: 1.8;">
                            <li>Works <strong>only outside of the Americas</strong></li>
                            <li>Supports most major cellular networks worldwide</li>
                            <li>Same great features and monitoring capabilities</li>
                        </ul>
                    </div>

                    <div class="intl-support-info">
                        <i class="fas fa-question-circle"></i>
                        <div>
                            <p style="margin: 0;"><strong>Questions about coverage in your country?</strong></p>
                            <p style="margin: 4px 0 0 0;">Please contact our customer service team at <a href="mailto:support@cabinpulse.com" style="color: var(--highlight-color); text-decoration: none;">support@cabinpulse.com</a> to confirm compatibility and coverage in your specific location.</p>
                        </div>
                    </div>
                </div>

                <div class="intl-modal-footer" style="justify-content: space-between;">
                    <button id="intl-modal-back-2b" class="intl-modal-btn" style="background: linear-gradient(135deg, rgba(15, 52, 96, 0.6) 0%, rgba(233, 69, 96, 0.3) 100%);">Back</button>
                    <button id="intl-modal-next-2b" class="intl-modal-btn">Next</button>
                </div>
            </div>

            <!-- Screen 3: Certification & Customs Information -->
            <div id="intl-modal-screen-3" class="intl-modal-screen">
                <div class="intl-modal-header">
                    <i class="fas fa-file-contract intl-modal-icon"></i>
                    <h2 class="intl-modal-title">Important Information</h2>
                </div>

                <div class="intl-modal-body">
                    <div class="info-box" style="margin-bottom: 24px; border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); border: 1px solid #4CAF50; border-radius: 12px; padding: 16px; display: flex; align-items: start; gap: 12px;">
                        <i class="fas fa-certificate" style="color: #4CAF50; font-size: 1.2rem; margin-top: 2px;"></i>
                        <div>
                            <p style="margin-bottom: 8px;"><strong>Certification Standards:</strong></p>
                            <p id="certification-text" style="font-size: 0.9rem; line-height: 1.6; margin: 0 0 12px 0;">
                                <!-- Will be populated dynamically based on device type -->
                            </p>
                            <p style="font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                Please note that different countries may have different wireless certification requirements or regulatory standards. As the importer, you are responsible for ensuring the device meets your country's specific regulatory requirements.
                            </p>
                        </div>
                    </div>

                    <div class="info-box" style="margin-bottom: 24px; border-color: #FFA726; background: rgba(255, 167, 38, 0.1); border: 1px solid #FFA726; border-radius: 12px; padding: 16px; display: flex; align-items: start; gap: 12px;">
                        <i class="fas fa-exclamation-triangle" style="color: #FFA726; font-size: 1.2rem; margin-top: 2px;"></i>
                        <div>
                            <p style="margin-bottom: 8px;"><strong>Customs Duties & Import Fees:</strong></p>
                            <p style="font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                As the importer, you are responsible for any applicable import duties, taxes, customs fees, or brokerage charges that may be assessed by your country's customs authorities. These fees vary by country and are not included in the purchase price. CabinPulse cannot predict or control these charges.
                            </p>
                        </div>
                    </div>

                    <div style="background: rgba(15, 52, 96, 0.4); border: 2px solid rgba(233, 69, 96, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 0;">
                        <label style="display: flex; align-items: start; gap: 12px; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="intl-modal-acknowledgment" style="width: 20px; height: 20px; margin-top: 2px; accent-color: var(--highlight-color); flex-shrink: 0;">
                            <span style="font-size: 0.9rem; line-height: 1.5;">
                                I understand and acknowledge that: (1) CabinPulse devices are certified with IC and FCC standards; (2) I am responsible for ensuring compliance with my country's regulatory requirements; and (3) I am liable for any import duties, taxes, customs fees, or brokerage charges assessed by my country's customs authorities.
                            </span>
                        </label>
                    </div>
                </div>

                <div class="intl-modal-footer" style="justify-content: space-between;">
                    <button id="intl-modal-back" class="intl-modal-btn" style="background: linear-gradient(135deg, rgba(15, 52, 96, 0.6) 0%, rgba(233, 69, 96, 0.3) 100%);">Back</button>
                    <button id="intl-modal-continue" class="intl-modal-btn" disabled>Check Network Compatibility</button>
                </div>
            </div>

            <!-- Screen 4: Network Compatibility -->
            <div id="intl-modal-screen-4" class="intl-modal-screen">
                <div class="intl-modal-header">
                    <i class="fas fa-signal intl-modal-icon"></i>
                    <h2 class="intl-modal-title">Network Compatibility</h2>
                </div>

                <div class="intl-modal-body">
                    <div id="compatibility-content">
                        <!-- Will be dynamically populated -->
                    </div>
                </div>

                <div class="intl-modal-footer" style="justify-content: space-between;">
                    <button id="intl-modal-back-4" class="intl-modal-btn" style="background: linear-gradient(135deg, rgba(15, 52, 96, 0.6) 0%, rgba(233, 69, 96, 0.3) 100%);">Back</button>
                    <button id="intl-modal-finish" class="intl-modal-btn">Continue to Shipping</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Safely validate plan parameter - default to '1' if invalid
            let planParam = urlParams.get('plan') || '1';
            let plan = (planParam === '1' || planParam === '3') ? planParam : '1';
            
            let currentStep = 1;
            let isLoginMode = false;
            let isAuthenticated = false;
            let userId = null;
            let authToken = null;
            let shippingCost = 0;
            let usTariff = 0;
            let selectedCountry = null;
            let referralCode = null;
            let isReferralValid = false;
            let quantity = 1;

            // Plan toggle functionality
            const compactToggles = document.querySelectorAll('.compact-toggle-option');
            const compactSlider = document.querySelector('.compact-toggle-slider');
            const confirmSavingsIndicator = document.querySelector('.compact-savings-indicator');

            // Quantity controls
            const quantityInput = document.getElementById('quantity-input');
            const quantityDecrease = document.getElementById('quantity-decrease');
            const quantityIncrease = document.getElementById('quantity-increase');

            function updateQuantity(newQuantity) {
                quantity = Math.max(1, Math.min(25, newQuantity));
                quantityInput.value = quantity;

                // Update button states
                quantityDecrease.disabled = quantity <= 1;
                quantityIncrease.disabled = quantity >= 25;

                // Update subtitle text
                const subLabel = document.getElementById('quantity-sub-label');

                if (quantity >= 25) {
                    subLabel.innerHTML = 'Need more than 25? <a href="mailto:support@cabinpulse.com?subject=Bulk Order Inquiry" style="color: var(--highlight-color); text-decoration: none; font-weight: 600;">Contact Sales</a>';
                } else {
                    subLabel.textContent = 'Select quantity';
                }

                // Recalculate shipping cost if a shipping option is already selected
                const selectedShipping = document.querySelector('.shipping-option.selected input[type="radio"]');
                if (selectedShipping) {
                    const baseCost = parseFloat(selectedShipping.value);
                    shippingCost = calculateShippingCost(baseCost, quantity);
                }

                // Update pricing
                updatePlanInfo();
            }

            quantityDecrease.addEventListener('click', function() {
                updateQuantity(quantity - 1);
            });

            quantityIncrease.addEventListener('click', function() {
                updateQuantity(quantity + 1);
            });

            quantityInput.addEventListener('input', function() {
                const value = parseInt(this.value) || 1;
                updateQuantity(value);
            });

            quantityInput.addEventListener('blur', function() {
                // Ensure valid value on blur
                if (!this.value || parseInt(this.value) < 1) {
                    updateQuantity(1);
                }
            });

            const plans = {
                1: { price: '14', label: 'billed annually', duration: '1-Year Plan', subscription: '$168/year' },
                3: { price: '10', label: 'billed every 3 years', duration: '3-Year Plan', subscription: '$360/3 years' }
            };

            // Prevent Enter key from submitting the form
            document.getElementById('purchaseForm').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    return false;
                }
            });

            // Initialize the plan toggle based on URL parameter
            function initializePlan() {
                // Update toggle state
                compactToggles.forEach(toggle => {
                    toggle.classList.remove('active');
                    if (toggle.dataset.plan === plan) {
                        toggle.classList.add('active');
                    }
                });
                
                // Update slider position
                if (plan === '3') {
                    compactSlider.classList.add('three-year');
                } else {
                    compactSlider.classList.remove('three-year');
                }

                // Initialize quantity button states
                quantityDecrease.disabled = quantity <= 1;
                quantityIncrease.disabled = quantity >= 25;

                updatePlanInfo();
            }

            // Referral Code Functionality
            const referralHeader = document.getElementById('referral-header');
            const referralToggle = document.getElementById('referral-toggle');
            const referralContent = document.getElementById('referral-content');
            const referralInput = document.getElementById('referral-code');
            const validateBtn = document.getElementById('validate-referral-btn');
            const referralFeedback = document.getElementById('referral-feedback');
            const referralFeedbackText = document.getElementById('referral-feedback-text');

            // Check for refcode in URL
            const refcodeParam = urlParams.get('refcode');
            if (refcodeParam) {
                referralCode = refcodeParam.toUpperCase();
                referralInput.value = referralCode;
                
                // Auto-open and validate if refcode is in URL
                referralContent.classList.add('open');
                referralToggle.classList.add('open');
                
                // Validate immediately - but don't block user progress
                setTimeout(() => {
                    validateReferralCode().catch(error => {
                        console.warn('Referral code validation failed:', error);
                        // Silently fail - don't block the user
                        referralCode = null;
                        isReferralValid = false;
                    });
                }, 500);
            }

            // Toggle referral section
            referralHeader.addEventListener('click', function() {
                referralContent.classList.toggle('open');
                referralToggle.classList.toggle('open');
            });

            // Validate referral code function
            async function validateReferralCode() {
                const code = referralInput.value.trim().toUpperCase();
                
                if (!code) {
                    referralFeedback.classList.remove('show', 'success', 'error');
                    referralInput.classList.remove('valid', 'invalid');
                    isReferralValid = false;
                    referralCode = null;
                    return;
                }
                
                validateBtn.disabled = true;
                validateBtn.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                
                try {
                    const response = await fetch('https://cabinpulse.com/api/users/referral/validate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            referral_code: code
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.json();
                    
                    referralFeedback.classList.add('show');
                    
                    if (data.valid) {
                        // Valid code
                        referralFeedback.classList.remove('error');
                        referralFeedback.classList.add('success');
                        referralFeedback.querySelector('i').className = 'fas fa-circle-check';
                        referralFeedbackText.textContent = data.referrer_name 
                            ? `Referred by ${data.referrer_name}.` 
                            : 'Valid referral code applied!';
                        referralInput.classList.remove('invalid');
                        referralInput.classList.add('valid');
                        isReferralValid = true;
                        referralCode = code;
                        validateBtn.textContent = 'Applied âœ“';
                    } else {
                        // Invalid code
                        referralFeedback.classList.remove('success');
                        referralFeedback.classList.add('error');
                        referralFeedback.querySelector('i').className = 'fas fa-circle-xmark';
                        referralFeedbackText.textContent = data.message || 'Invalid referral code';
                        referralInput.classList.remove('valid');
                        referralInput.classList.add('invalid');
                        isReferralValid = false;
                        referralCode = null;
                        validateBtn.textContent = 'Apply';
                    }
                } catch (error) {
                    console.error('Error validating referral code:', error);
                    referralFeedback.classList.add('show', 'error');
                    referralFeedback.querySelector('i').className = 'fas fa-circle-xmark';
                    referralFeedbackText.textContent = 'Error validating code. Please try again.';
                    referralInput.classList.remove('valid');
                    referralInput.classList.add('invalid');
                    isReferralValid = false;
                    referralCode = null;
                    validateBtn.textContent = 'Apply';
                } finally {
                    validateBtn.disabled = false;
                    // Always re-enable button, never block user
                    if (!isReferralValid) {
                        validateBtn.textContent = 'Apply';
                    }
                }
            }

            // Apply button click
            validateBtn.addEventListener('click', validateReferralCode);

            // Validate on Enter key
            referralInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    validateReferralCode();
                }
            });

            // Clear validation when input changes
            referralInput.addEventListener('input', function(e) {
                this.value = this.value.toUpperCase();
                
                if (isReferralValid) {
                    referralFeedback.classList.remove('show');
                    referralInput.classList.remove('valid', 'invalid');
                    isReferralValid = false;
                    referralCode = null;
                    validateBtn.textContent = 'Apply';
                }
            });

            // Debounce function for API calls
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Validation functions
            function showFieldError(fieldId, message) {
                const field = document.getElementById(fieldId);
                const existingMessage = field.parentElement.querySelector('.validation-message');
                
                if (existingMessage) {
                    existingMessage.remove();
                }

                field.classList.add('invalid');
                
                const messageElement = document.createElement('div');
                messageElement.className = 'validation-message';
                messageElement.textContent = message;
                
                field.parentElement.appendChild(messageElement);
            }

            function clearFieldError(fieldId) {
                const field = document.getElementById(fieldId);
                const existingMessage = field.parentElement.querySelector('.validation-message');
                
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                field.classList.remove('invalid');
            }

            function showValidationError(formId, message) {
                const form = document.getElementById(formId);
                const existingError = form.querySelector('.form-error-message');
                
                if (existingError) {
                    existingError.remove();
                }

                const errorElement = document.createElement('div');
                errorElement.className = 'form-error-message';
                errorElement.textContent = message;
                
                form.appendChild(errorElement);
            }

            function clearValidationMessages(formId) {
                const form = document.getElementById(formId);
                form.querySelectorAll('.validation-message, .form-error-message').forEach(el => el.remove());
                form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            }

            // API functions
            async function checkFieldAvailability(field, value, country = null) {
                try {
                    const body = { [field]: value };
                    
                    // For phone numbers, include country code
                    if (field === 'phone' && country) {
                        body.country = country;
                    }
                    
                    const response = await fetch('https://cabinpulse.com/api/users/check-availability', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    return data.availability[field];
                } catch (error) {
                    console.error('Error checking availability:', error);
                    return { available: false, message: 'Error checking availability' };
                }
            }

            async function authenticateUser(email, password) {
                try {
                    const response = await fetch('https://cabinpulse.com/api/users/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email,
                            password
                        })
                    });

                    if (!response.ok) {
                        return false;
                    }

                    const data = await response.json();
                    isAuthenticated = true;
                    userId = data.userId;
                    authToken = data.token;
                    return true;
                } catch (error) {
                    console.error('Authentication error:', error);
                    return false;
                }
            }

            function updatePlanInfo() {
                const planData = plans[plan];
                const monthlyPrice = parseInt(planData.price);
                const planCost = monthlyPrice * (plan === '1' ? 12 : 36);
                const deviceCost = 199 * quantity;
                const subscriptionCost = planCost * quantity;
                const totalAmount = deviceCost + subscriptionCost + shippingCost + usTariff;

                // Update confirmation step elements
                document.getElementById('confirm-monthly-price').textContent = planData.price;
                document.getElementById('confirm-price-label').textContent = planData.label;
                document.getElementById('confirm-plan-duration').textContent = planData.duration;

                // Update costs with quantity
                if (quantity > 1) {
                    document.getElementById('confirm-subscription-cost').textContent = `$${subscriptionCost}/${plan === '1' ? 'year' : '3 years'} (${quantity} units)`;
                    document.getElementById('confirm-device-fee').textContent = `$${deviceCost} CAD (${quantity} units)`;
                } else {
                    document.getElementById('confirm-subscription-cost').textContent = planData.subscription;
                    document.getElementById('confirm-device-fee').textContent = '$199 CAD';
                }

                document.getElementById('confirm-total-due').textContent = `$${totalAmount} CAD`;

                // Update savings indicator
                if (plan === '3') {
                    confirmSavingsIndicator.textContent = "Saving 29%";
                    confirmSavingsIndicator.classList.add('activated');
                } else {
                    confirmSavingsIndicator.textContent = "Save 29%!";
                    confirmSavingsIndicator.classList.remove('activated');
                }

                // Update URL
                urlParams.set('plan', plan);
                window.history.replaceState({}, '', `${window.location.pathname}?${urlParams}`);

                updateShippingSummary();
            }

            function updateShippingSummary() {
                const shippingSummaryRow = document.getElementById('confirm-shipping-summary-row');
                const shippingCostElement = document.getElementById('confirm-shipping-cost');
                const tariffSummaryRow = document.getElementById('confirm-tariff-summary-row');

                if (shippingCost > 0) {
                    shippingSummaryRow.style.display = 'flex';
                    shippingCostElement.textContent = `$${shippingCost.toFixed(2)} CAD`;
                } else {
                    shippingSummaryRow.style.display = 'flex';
                    shippingCostElement.textContent = 'FREE';
                }

                // Show/hide tariff row for US orders
                if (usTariff > 0) {
                    tariffSummaryRow.style.display = 'flex';
                } else {
                    tariffSummaryRow.style.display = 'none';
                }
            }

            compactToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const newPlan = this.dataset.plan;
                    if (newPlan === plan) return;

                    // Confetti for upgrade to 3-year
                    if (plan === '1' && newPlan === '3') {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { x: 0.5, y: 0.3 }
                        });
                    }

                    plan = newPlan;
                    
                    compactToggles.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    compactSlider.classList.toggle('three-year', plan === '3');
                    
                    updatePlanInfo();
                });
            });

            function scrollToAccountForm() {
                // Only scroll on mobile devices
                if (window.innerWidth <= 768) {
                    const newUserForm = document.getElementById('new-user-form');
                    const existingUserForm = document.getElementById('existing-user-form');
                    
                    // Determine which form is visible
                    const visibleForm = newUserForm.style.display === 'block' ? newUserForm : existingUserForm;
                    
                    if (visibleForm) {
                        // Small delay to ensure the form is visible first
                        setTimeout(() => {
                            const rect = visibleForm.getBoundingClientRect();
                            const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                            
                            // Only scroll if the form isn't fully visible
                            if (!isVisible) {
                                // Scroll just enough to show the form
                                const scrollOffset = rect.top - window.innerHeight * 0.7; // Show at 70% down the screen
                                window.scrollBy({
                                    top: scrollOffset,
                                    behavior: 'smooth'
                                });
                            }
                        }, 100);
                    }
                }
            }

            // Country selection with validation
            document.querySelectorAll('.selection-option[data-country]').forEach(option => {
                option.addEventListener('click', function() {
                    const country = this.dataset.country;
                    selectedCountry = country;

                    // Set US tariff if shipping to USA
                    if (country === 'US') {
                        usTariff = 90;
                    } else {
                        usTariff = 0;
                    }

                    // Update selection state
                    document.querySelectorAll('.selection-option[data-country]').forEach(opt =>
                        opt.classList.remove('selected'));
                    this.classList.add('selected');

                    // For international shipping, show modal first
                    if (country === 'INTL') {
                        const modal = document.getElementById('intl-modal');
                        modal.classList.add('visible');
                        // Don't show shipping options yet - wait for modal continue
                    } else {
                        // Show shipping options for CA and US
                        showShippingOptions(country);
                        // Scroll to shipping options on mobile
                        scrollToShippingOptions();
                    }
                });
            });

            // International modal - Track selected region
            let selectedRegion = null;

            // Define which countries are in the Americas (use standard CabinPulse B504)
            // Countries removed: BR, CL, GY, SR (these use CabinPulse Global B524)
            // All others use CabinPulse Global
            const americasCountries = ['MX', 'BZ', 'CR', 'SV', 'GT', 'HN', 'NI', 'PA', 'AR', 'BO', 'CO', 'EC', 'PY', 'PE', 'UY', 'VE'];

            // Coverage status for each country
            const coverageStatus = {
                // Americas - "Likely to Work" (use standard B504)
                // Removed BR, CL, GY, SR - these use Global B524
                'AR': 'likely', 'BZ': 'likely', 'BO': 'likely',
                'CO': 'likely', 'CR': 'may', 'EC': 'likely', 'SV': 'likely', 'GT': 'likely',
                'HN': 'likely', 'MX': 'likely', 'NI': 'likely', 'PA': 'likely',
                'PY': 'likely', 'PE': 'likely', 'UY': 'likely', 'VE': 'likely',

                // All other countries in dropdown use CabinPulse Global B524
                // Including: BR, CL, GY, SR (South America), SG, AE (Asia/Middle East)
                // And officially supported: GB, IE, FR, DE, IT, ES, PT, NL, BE, CH, AT, SE, NO, DK, FI, PL, CZ, HK, JP, MY, KR, TW, TH, AU, NZ, ZA
            };

            // Carriers for officially supported countries (CabinPulse Global)
            const officialCarriers = {
                'AU': ['Optus', 'Telstra', 'Vodafone'],
                'AT': ['3 (Drei)', 'A1', 'T-Mobile'],
                'BE': ['Base', 'Orange', 'Proximus'],
                'CH': ['Salt', 'Sunrise', 'Swisscom'],
                'CZ': ['O2', 'T-Mobile', 'Vodafone'],
                'DE': ['O2', 'Telekom', 'Vodafone'],
                'DK': ['3 (Tre)', 'TDC', 'Telenor', 'Telia'],
                'ES': ['Orange', 'Telefonica', 'Vodafone', 'Yoigo'],
                'FI': ['DNA', 'Elisa', 'Telia'],
                'FR': ['Bouygues', 'Free Mobile', 'Orange', 'SFR'],
                'GB': ['3', 'EE', 'O2', 'Vodafone'],
                'HK': ['CMHK', 'CSL', 'SmarTone'],
                'IE': ['3 (Tre)', 'Meteor', 'O2', 'Vodafone'],
                'IT': ['TIM', 'Vodafone', 'Wind'],
                'JP': ['KDDI', 'NTT DoCoMo', 'Softbank'],
                'KR': ['KT', 'LG U+', 'SK Telecom'],
                'MY': ['Celcom', 'DiGi', 'Maxis'],
                'NL': ['KPN', 'T-Mobile', 'Vodafone'],
                'NO': ['TDC', 'Telenor', 'Telia'],
                'NZ': ['2degrees', 'Spark', 'Vodafone'],
                'PL': ['Orange', 'Play', 'Plus', 'T-Mobile'],
                'PT': ['NOS', 'TMN', 'Vodafone'],
                'SE': ['3 (Tre)', 'Tele2', 'Telenor', 'Telia'],
                'TH': ['AIS', 'DTAC', 'True Move'],
                'TW': ['Chunghwa', 'FarEasTone', 'T Star', 'Taiwan Mobile'],
                'ZA': ['Cell C', 'MTN', 'Vodacom'],
            };

            // Country selection from single dropdown
            const intlCountrySelect = document.getElementById('intl-country-select');

            intlCountrySelect.addEventListener('change', function() {
                if (this.value) {
                    // Store the selected country value
                    const countryCode = this.value;
                    selectedCountry = countryCode;

                    // Special handling for CA/US - bypass modal and go straight to shipping
                    if (countryCode === 'CA' || countryCode === 'US') {
                        const modal = document.getElementById('intl-modal');
                        modal.classList.remove('visible');

                        // Reset modal to screen 1 for next time
                        document.getElementById('intl-modal-screen-1').classList.add('active');
                        intlCountrySelect.value = '';

                        // Set US tariff if USA
                        if (countryCode === 'US') {
                            usTariff = 90;
                        } else {
                            usTariff = 0;
                        }

                        // Update selection state in the country buttons
                        document.querySelectorAll('.selection-option[data-country]').forEach(opt =>
                            opt.classList.remove('selected'));
                        const countryButton = document.querySelector(`.selection-option[data-country="${countryCode}"]`);
                        if (countryButton) {
                            countryButton.classList.add('selected');
                        }

                        // Show shipping options for selected country
                        showShippingOptions(countryCode);
                        scrollToShippingOptions();
                    }
                    // Determine if this is Americas or Rest of World
                    else if (americasCountries.includes(countryCode)) {
                        selectedRegion = 'americas';

                        // Reset screen 2a to Americas content in case it was changed
                        const screen2aIcon = document.querySelector('#intl-modal-screen-2a .intl-modal-icon');
                        const screen2aTitle = document.querySelector('#intl-modal-screen-2a .intl-modal-title');
                        const screen2aBody = document.querySelector('#intl-modal-screen-2a .intl-modal-body p');
                        const screen2aDeviceText = document.querySelector('#intl-modal-screen-2a .intl-device-highlight p');

                        screen2aIcon.className = 'fas fa-earth-americas intl-modal-icon';
                        screen2aTitle.textContent = 'Americas Shipping';
                        screen2aBody.innerHTML = 'Thank you for your interest in CabinPulse! For shipments to North, Central, and South America, we ship the standard <strong>CabinPulse</strong> device.';
                        screen2aDeviceText.textContent = 'The standard CabinPulse device works throughout the Americas region with full cellular connectivity and all monitoring features.';

                        // Transition to Americas device info screen
                        document.getElementById('intl-modal-screen-1').classList.remove('active');
                        document.getElementById('intl-modal-screen-2a').classList.add('active');
                    } else {
                        selectedRegion = 'row';
                        // Transition to Rest of World device info screen
                        document.getElementById('intl-modal-screen-1').classList.remove('active');
                        document.getElementById('intl-modal-screen-2b').classList.add('active');
                    }
                }
            });

            // Back button from Americas screen (2a) to region selection (1)
            document.getElementById('intl-modal-back-2a').addEventListener('click', function() {
                document.getElementById('intl-modal-screen-2a').classList.remove('active');
                document.getElementById('intl-modal-screen-1').classList.add('active');
                // Reset dropdown selection and region
                intlCountrySelect.value = '';
                selectedRegion = null;
            });

            // Next button from Americas screen (2a) to certification (3)
            document.getElementById('intl-modal-next-2a').addEventListener('click', function() {
                // Update certification text for CabinPulse Standard
                document.getElementById('certification-text').innerHTML = '<strong>CabinPulse Standard:</strong> FCC (United States), ISED (Canada)';

                document.getElementById('intl-modal-screen-2a').classList.remove('active');
                document.getElementById('intl-modal-screen-3').classList.add('active');
            });

            // Back button from Rest of World screen (2b) to region selection (1)
            document.getElementById('intl-modal-back-2b').addEventListener('click', function() {
                document.getElementById('intl-modal-screen-2b').classList.remove('active');
                document.getElementById('intl-modal-screen-1').classList.add('active');
                // Reset dropdown selection and region
                intlCountrySelect.value = '';
                selectedRegion = null;
            });

            // Next button from Rest of World screen (2b) to certification (3)
            document.getElementById('intl-modal-next-2b').addEventListener('click', function() {
                // Update certification text for CabinPulse Global
                document.getElementById('certification-text').innerHTML = '<strong>CabinPulse Global:</strong> CE (Europe), UKCA (United Kingdom), Japan (D 24 0029 201, 201 240198)';

                document.getElementById('intl-modal-screen-2b').classList.remove('active');
                document.getElementById('intl-modal-screen-3').classList.add('active');
            });

            // Back button from certification screen (3) - returns to appropriate device screen
            document.getElementById('intl-modal-back').addEventListener('click', function() {
                document.getElementById('intl-modal-screen-3').classList.remove('active');
                if (selectedRegion === 'americas' || selectedRegion === 'special') {
                    document.getElementById('intl-modal-screen-2a').classList.add('active');
                } else {
                    document.getElementById('intl-modal-screen-2b').classList.add('active');
                }
            });

            // Handle checkbox to enable/disable continue button
            document.getElementById('intl-modal-acknowledgment').addEventListener('change', function() {
                const continueBtn = document.getElementById('intl-modal-continue');
                continueBtn.disabled = !this.checked;
            });

            // Continue to network compatibility (from screen 3 to screen 4)
            document.getElementById('intl-modal-continue').addEventListener('click', function() {
                // Populate compatibility screen
                showNetworkCompatibility(selectedCountry);

                // Transition to screen 4
                document.getElementById('intl-modal-screen-3').classList.remove('active');
                document.getElementById('intl-modal-screen-4').classList.add('active');
            });

            // Back button from compatibility screen (4) to certification (3)
            document.getElementById('intl-modal-back-4').addEventListener('click', function() {
                document.getElementById('intl-modal-screen-4').classList.remove('active');
                document.getElementById('intl-modal-screen-3').classList.add('active');
            });

            // Finish button from compatibility screen (4) - close modal and show shipping
            document.getElementById('intl-modal-finish').addEventListener('click', function() {
                const modal = document.getElementById('intl-modal');
                modal.classList.remove('visible');

                // Reset modal to screen 1 for next time
                document.getElementById('intl-modal-screen-4').classList.remove('active');
                document.getElementById('intl-modal-screen-3').classList.remove('active');
                document.getElementById('intl-modal-screen-2a').classList.remove('active');
                document.getElementById('intl-modal-screen-2b').classList.remove('active');
                document.getElementById('intl-modal-screen-1').classList.add('active');

                // Reset checkbox for next time
                document.getElementById('intl-modal-acknowledgment').checked = false;
                document.getElementById('intl-modal-continue').disabled = true;

                // Reset dropdown for next time
                intlCountrySelect.value = '';

                // Reset selected region (but keep selectedCountry as it's needed for checkout)
                selectedRegion = null;

                // Now show shipping options for international
                showShippingOptions('INTL');
                // Scroll to shipping options on mobile
                scrollToShippingOptions();
            });

            // Function to show network compatibility
            function showNetworkCompatibility(countryCode) {
                const content = document.getElementById('compatibility-content');
                const status = coverageStatus[countryCode] || 'official';
                const countryName = document.querySelector(`option[value="${countryCode}"]`).textContent;

                let html = '';

                if (status === 'likely') {
                    // Likely to work - Standard device
                    html = `
                        <div class="info-box" style="margin-bottom: 20px; border-color: #4CAF50; background: rgba(76, 175, 80, 0.1);">
                            <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                            <div>
                                <p style="margin-bottom: 8px;"><strong>Your device will work in ${countryName}!</strong></p>
                                <p style="margin: 0;">CabinPulse is expected to work with local cellular networks in your country.</p>
                            </div>
                        </div>
                    `;
                } else if (status === 'may') {
                    // May work - Standard device
                    html = `
                        <div class="info-box" style="margin-bottom: 20px; border-color: #FFA726; background: rgba(255, 167, 38, 0.1);">
                            <i class="fas fa-info-circle" style="color: #FFA726;"></i>
                            <div>
                                <p style="margin-bottom: 8px;"><strong>Coverage may vary in ${countryName}</strong></p>
                                <p style="margin: 0;">CabinPulse may work in your country, but coverage is not guaranteed and may vary by location. We recommend contacting <a href="mailto:support@cabinpulse.com" style="color: var(--highlight-color);">support@cabinpulse.com</a> to confirm compatibility.</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Global device (official or expected to work)
                    const carriers = officialCarriers[countryCode] || [];

                    if (carriers.length > 0) {
                        // Official support with known carriers
                        html = `
                            <div class="info-box" style="margin-bottom: 20px; border-color: #4CAF50; background: rgba(76, 175, 80, 0.1);">
                                <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                                <div>
                                    <p style="margin-bottom: 8px;"><strong>Your CabinPulse Global will work in ${countryName}!</strong></p>
                                    <p style="margin: 0;">Compatible with major carriers including:</p>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
                                ${carriers.map(carrier => `
                                    <div style="background: rgba(15, 52, 96, 0.3); border: 1px solid rgba(233, 69, 96, 0.3); border-radius: 8px; padding: 12px; text-align: center;">
                                        <i class="fas fa-signal" style="color: var(--highlight-color); margin-bottom: 4px;"></i>
                                        <div style="font-size: 0.9rem; font-weight: 500;">${carrier}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        // Global device but no specific carrier data yet (e.g., BR, CL, GY, SR, SG, AE)
                        html = `
                            <div class="info-box" style="margin-bottom: 20px; border-color: #4CAF50; background: rgba(76, 175, 80, 0.1);">
                                <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                                <div>
                                    <p style="margin-bottom: 8px;"><strong>Your CabinPulse Global will work in ${countryName}!</strong></p>
                                    <p style="margin: 0;">The CabinPulse Global device is expected to work with local cellular networks in your country.</p>
                                </div>
                            </div>
                        `;
                    }
                }

                content.innerHTML = html;
            }

            function showShippingOptions(country) {
                const shippingOptions = document.getElementById('shipping-options');
                const container = document.getElementById('shipping-options-container');
                
                // Show enhanced loading state
                container.innerHTML = `
                    <div class="shipping-loader">
                        <div class="loader-spinner"></div>
                        <div class="loader-text">Loading shipping options...</div>
                    </div>
                `;
                shippingOptions.classList.add('visible');
                
                setTimeout(() => {
                    let optionsHTML = '';
                    
                    if (country === 'CA') {
                        optionsHTML = `
                            <div class="shipping-option" data-cost="0">
                                <input type="radio" name="shipping" value="0" id="canada-post-free">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg" 
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Expedited Parcel</span>
                                            <i class="fas fa-truck" style="color: var(--highlight-color); margin-left: 4px;"></i>
                                        </div>
                                        <span class="shipping-price">FREE</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers in 2-6 business days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="shipping-option" data-cost="35">
                                <input type="radio" name="shipping" value="35" id="canada-post-xpresspost">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg" 
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Xpresspost</span>
                                            <i class="fas fa-plane" style="color: var(--highlight-color); margin-left: 4px;"></i>
                                        </div>
                                        <span class="shipping-price">$35.00</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers in 1-2 business days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="shipping-option" data-cost="70">
                                <input type="radio" name="shipping" value="70" id="canada-post-priority">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg" 
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Priority</span>
                                            <i class="fas fa-bolt" style="color: var(--highlight-color); margin-left: 4px;"></i>
                                        </div>
                                        <span class="shipping-price">$70.00</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers next business day</span>
                                    </div>
                                </div>
                            </div>
                            <div class="info-box" style="margin-top: 20px; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i>
                                <p>Getting multiple devices? Additional shipping is 25% of base rate per extra device.</p>
                            </div>
                        `;
                    } else if (country === 'US') {
                        optionsHTML = `
                            <div class="info-box" style="margin-bottom: 24px;">
                                <i class="fas fa-info-circle"></i>
                                <p><strong>US Import Tariff Notice:</strong> US Customs mandates import duties on Canadian shipments to the USA. To comply with US regulations, we collect a $90 CAD fee that covers the government-imposed tariff and necessary customs broker fees to process your shipment through US Customs.</p>
                            </div>
                            <div class="shipping-option" data-cost="0">
                                <input type="radio" name="shipping" value="0" id="tracked-packet">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg" 
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Tracked Packet</span>
                                        </div>
                                        <span class="shipping-price">FREE</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers in 5-7 business days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="shipping-option" data-cost="45">
                                <input type="radio" name="shipping" value="45" id="canada-post-expedited">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg" 
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Expedited Parcel</span>
                                            <i class="fas fa-truck" style="color: var(--highlight-color); margin-left: 4px;"></i>
                                        </div>
                                        <span class="shipping-price">$45.00</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers in 4-6 business days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="shipping-option" data-cost="75">
                                <input type="radio" name="shipping" value="75" id="canada-post-xpresspost-usa">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg" 
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Xpresspost USA</span>
                                            <i class="fas fa-plane" style="color: var(--highlight-color); margin-left: 4px;"></i>
                                        </div>
                                        <span class="shipping-price">$75.00</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers in 2-5 business days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="info-box" style="margin-top: 20px; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i>
                                <p>Getting multiple devices? Additional shipping is 25% of base rate per extra device.</p>
                            </div>
                        `;
                    } else if (country === 'INTL') {
                        // For international, the country was already selected in the modal (stored in selectedCountry)
                        optionsHTML = `
                            <div class="info-box" style="margin-bottom: 20px;">
                                <i class="fas fa-shipping-fast"></i>
                                <p>Delivery times may vary depending on your location and local customs processing. Full tracking is provided for all international shipments.</p>
                            </div>
                            <div class="shipping-option" data-cost="35">
                                <input type="radio" name="shipping" value="35" id="tracked-packet-intl">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg"
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Tracked Packet International</span>
                                            <i class="fas fa-ship" style="color: var(--highlight-color); margin-left: 4px;"></i>
                                        </div>
                                        <span class="shipping-price">$35.00</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers in 6-10 business days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="shipping-option" data-cost="75">
                                <input type="radio" name="shipping" value="75" id="xpresspost-intl">
                                <div class="shipping-details">
                                    <div class="shipping-name">
                                        <div class="shipping-provider">
                                            <img src="https://www.canadapost-postescanada.ca/cpc/assets/cpc/uploads/logos/cpc-scp/primary/postmarks-80x80.svg"
                                                 alt="Canada Post" class="shipping-logo">
                                            <span>Xpresspost International</span>
                                            <i class="fas fa-plane" style="color: var(--highlight-color); margin-left: 4px;"></i>
                                        </div>
                                        <span class="shipping-price">$75.00</span>
                                    </div>
                                    <div class="shipping-estimate">
                                        <i class="fas fa-clock"></i>
                                        <span>Usually delivers in 4-7 business days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="info-box" style="margin-top: 20px; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i>
                                <p>Getting multiple devices? Additional shipping is 25% of base rate per extra device.</p>
                            </div>
                        `;
                    }

                    container.innerHTML = optionsHTML;

                    // Add event listeners for shipping options
                    document.querySelectorAll('.shipping-option').forEach(option => {
                        option.addEventListener('click', function() {
                            const radio = this.querySelector('input[type="radio"]');
                            radio.checked = true;
                            const baseCost = parseFloat(radio.value);
                            shippingCost = calculateShippingCost(baseCost, quantity);

                            // Update selection state
                            document.querySelectorAll('.shipping-option').forEach(opt =>
                                opt.classList.remove('selected'));
                            this.classList.add('selected');

                            // Update pricing
                            updatePlanInfo();

                            // Enable continue button when shipping is selected
                            document.getElementById('step1-continue').disabled = false;
                        });
                    });

                    if (country === 'INTL') {
                        // For international, don't auto-select - require explicit selection
                        // Acknowledgment was already done in the modal
                        document.getElementById('step1-continue').disabled = true;
                    } else {
                        // Auto-select first option for CA and US
                        if (country === 'CA' || country === 'US') {
                            const firstOption = container.querySelector('.shipping-option');
                            const firstRadio = firstOption.querySelector('input[type="radio"]');
                            firstRadio.checked = true;
                            firstOption.classList.add('selected');
                            const baseCost = parseFloat(firstRadio.value);
                            shippingCost = calculateShippingCost(baseCost, quantity);
                            updatePlanInfo();
                            document.getElementById('step1-continue').disabled = false;
                        }
                    }
                }, 1000);
            }

            // Calculate shipping cost based on quantity
            // Base cost + (base cost * 0.25 * (quantity - 1))
            function calculateShippingCost(baseCost, qty) {
                if (baseCost === 0) return 0; // Free shipping stays free
                return baseCost + (baseCost * 0.25 * (qty - 1));
            }

            // Smooth scroll to shipping options on mobile
            function scrollToShippingOptions() {
                // Only scroll on mobile devices
                if (window.innerWidth <= 768) {
                    const shippingOptions = document.getElementById('shipping-options');
                    if (shippingOptions) {
                        // Small delay to ensure the shipping options are visible first
                        setTimeout(() => {
                            const rect = shippingOptions.getBoundingClientRect();
                            const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                            
                            // Only scroll if the shipping options aren't fully visible
                            if (!isVisible) {
                                // Scroll just enough to show the shipping options
                                const scrollOffset = rect.top - window.innerHeight * 0.7; // Show at 70% down the screen
                                window.scrollBy({
                                    top: scrollOffset,
                                    behavior: 'smooth'
                                });
                            }
                        }, 100);
                    }
                }
            }

            // Account type selection
            document.querySelectorAll('.selection-option[data-type]').forEach(option => {
                option.addEventListener('click', function() {
                    const type = this.dataset.type;
                    
                    // Update selection state
                    document.querySelectorAll('.selection-option[data-type]').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const newUserForm = document.getElementById('new-user-form');
                    const existingUserForm = document.getElementById('existing-user-form');
                    
                    if (type === 'new') {
                        newUserForm.style.display = 'block';
                        existingUserForm.style.display = 'none';
                        isLoginMode = false;
                        
                        // Set required fields
                        existingUserForm.querySelectorAll('input').forEach(input => {
                            input.required = false;
                        });
                        newUserForm.querySelectorAll('input').forEach(input => {
                            input.required = true;
                        });
                    } else {
                        newUserForm.style.display = 'none';
                        existingUserForm.style.display = 'block';
                        isLoginMode = true;
                        
                        // Set required fields
                        newUserForm.querySelectorAll('input').forEach(input => {
                            input.required = false;
                        });
                        existingUserForm.querySelectorAll('input').forEach(input => {
                            input.required = true;
                        });
                    }
                    
                    // Add scroll effect for mobile
                    scrollToAccountForm();
                });
            });

            // Real-time validation for email and phone
            document.getElementById('email')?.addEventListener('input', debounce(async function(e) {
                const email = e.target.value.trim();
                if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    const result = await checkFieldAvailability('email', email);
                    if (!result.available) {
                        showFieldError('email', result.message);
                    } else {
                        clearFieldError('email');
                    }
                }
            }, 500));

            document.getElementById('phone')?.addEventListener('input', debounce(async function(e) {
                const phone = e.target.value.trim().replace(/\D/g, ''); // Remove non-digits
                const country = document.getElementById('phone-country').value;
                
                if (phone && phone.length >= 10) {
                    const result = await checkFieldAvailability('phone', phone, country);
                    if (!result.available) {
                        showFieldError('phone', result.message);
                    } else {
                        clearFieldError('phone');
                    }
                }
            }, 500));

            function validateStep(step) {
                if (step === 1) {
                    if (!selectedCountry) {
                        alert('Please select a country.');
                        return false;
                    }
                    
                    const selectedShipping = document.querySelector('input[name="shipping"]:checked');
                    if (!selectedShipping) {
                        alert('Please select a shipping option.');
                        return false;
                    }
                    return true;
                }
                
                if (step === 2) {
                    const selectedOption = document.querySelector('.selection-option[data-type].selected');
                    if (!selectedOption) {
                        alert('Please select an account type.');
                        return false;
                    }
                    
                    // Validate form fields
                    const activeForm = isLoginMode ? 'existing-user-form' : 'new-user-form';
                    const form = document.getElementById(activeForm);
                    const inputs = form.querySelectorAll('input[required]');
                    
                    for (const input of inputs) {
                        if (!input.value.trim()) {
                            input.focus();
                            return false;
                        }
                    }
                    return true;
                }
                
                return true;
            }

            // Step navigation
            window.nextStep = async function() {
                if (!validateStep(currentStep)) return;
                
                const currentStepElement = document.getElementById(`step-${currentStep}`);
                const nextStepElement = document.getElementById(`step-${currentStep + 1}`);
                const currentIndicator = document.getElementById(`indicator-${currentStep}`);
                const nextIndicator = document.getElementById(`indicator-${currentStep + 1}`);
                
                // Special handling for step 2 (account validation)
                if (currentStep === 2) {
                    const continueButton = document.querySelector('#step-2 .btn-primary');
                    const originalHTML = continueButton.innerHTML;
                    
                    continueButton.disabled = true;
                    continueButton.innerHTML = '<div class="loading"><div class="spinner"></div> Validating...</div>';
                    
                    try {
                        if (isLoginMode) {
                            const email = document.getElementById('login-email').value;
                            const password = document.getElementById('login-password').value;

                            const success = await authenticateUser(email, password);
                            if (!success) {
                                showValidationError('existing-user-form', 'Invalid email or password. Please try again.');
                                continueButton.disabled = false;
                                continueButton.innerHTML = originalHTML;
                                return;
                            }
                        } else {
                            const email = document.getElementById('email').value;
                            const phone = document.getElementById('phone').value.trim().replace(/\D/g, ''); // Remove non-digits
                            const phoneCountry = document.getElementById('phone-country').value;

                            const response = await fetch('https://cabinpulse.com/api/users/check-availability', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    email,
                                    phone,
                                    country: phoneCountry
                                })
                            });

                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }

                            const data = await response.json();
                            const { availability } = data;

                            let hasError = false;
                            clearValidationMessages('new-user-form');

                            if (!availability.email.available) {
                                showFieldError('email', availability.email.message);
                                hasError = true;
                            }

                            if (!availability.phone.available) {
                                showFieldError('phone', availability.phone.message);
                                hasError = true;
                            }

                            if (hasError) {
                                continueButton.disabled = false;
                                continueButton.innerHTML = originalHTML;
                                return;
                            }
                        }
                        
                    } catch (error) {
                        console.error('Validation error:', error);
                        showValidationError(isLoginMode ? 'existing-user-form' : 'new-user-form', 'An error occurred during validation. Please try again.');
                        continueButton.disabled = false;
                        continueButton.innerHTML = originalHTML;
                        return;
                    }
                    
                    continueButton.disabled = false;
                    continueButton.innerHTML = originalHTML;
                }
                
                // Animate step transition
                currentStepElement.classList.remove('active');
                currentIndicator.classList.remove('active');
                
                setTimeout(() => {
                    nextStepElement.classList.add('active');
                    nextIndicator.classList.add('active');
                    currentStep++;
                }, 300);
            };

            window.previousStep = function() {
                if (currentStep <= 1) return;
                
                const currentStepElement = document.getElementById(`step-${currentStep}`);
                const previousStepElement = document.getElementById(`step-${currentStep - 1}`);
                const currentIndicator = document.getElementById(`indicator-${currentStep}`);
                const previousIndicator = document.getElementById(`indicator-${currentStep - 1}`);
                
                currentStepElement.classList.remove('active');
                currentIndicator.classList.remove('active');
                
                setTimeout(() => {
                    previousStepElement.classList.add('active');
                    previousIndicator.classList.add('active');
                    currentStep--;
                }, 300);
            };

            // Form submission
            document.getElementById('purchaseForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitButton = document.getElementById('payment-button');
                const originalHTML = submitButton.innerHTML;
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="loading"><div class="spinner"></div> Processing...</div>';
                
                try {
                    // Calculate totals with quantity
                    const monthlyPrice = plan === '1' ? 14 : 10;
                    const planCostPerUnit = monthlyPrice * (plan === '1' ? 12 : 36);
                    const planCost = planCostPerUnit * quantity;
                    const deviceCost = 199 * quantity;
                    const totalAmount = (deviceCost + planCost + shippingCost + usTariff) * 100; // Convert to cents


                    let customerInfo;
                    if (isLoginMode) {
                        customerInfo = {
                            email: document.getElementById('login-email').value,
                            existingUser: true
                        };
                    } else {
                        const phoneNumber = document.getElementById('phone').value.trim().replace(/\D/g, ''); // Remove non-digits
                        const phoneCountry = document.getElementById('phone-country').value;
                        
                        customerInfo = {
                            email: document.getElementById('email').value,
                            phone: {
                                country: phoneCountry,
                                number: phoneNumber
                            },
                            name: document.getElementById('name').value,
                            existingUser: false
                        };
                    }
                    
                    // Create checkout session
                    const response = await fetch('https://cabinpulse.com/api/create-checkout-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            planType: plan === '1' ? '1-year' : '3-year',
                            customerInfo,
                            userType: isLoginMode ? 'existing' : 'new',
                            country: selectedCountry,
                            shippingCost: shippingCost,
                            quantity: quantity,
                            referralCode: isReferralValid ? referralCode : null,
                            usTariff: usTariff,
                            priceData: {
                                deviceCost,
                                planCost,
                                shippingCost,
                                usTariff,
                                totalAmount
                            },
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to create checkout session');
                    }
                    
                    const { sessionId } = await response.json();
                    const stripe = Stripe('pk_live_51LZK81EVmyPNhExzHXm1BF3uC8BO6iTdg6R3hrrcjo3XEnq6fral763hSpQppYgCnRzNZO6zeCVHdq2aJ835k37e00Vhl33gOG');
                    
                    // Redirect to checkout
                    const { error } = await stripe.redirectToCheckout({
                        sessionId: sessionId
                    });
                    
                    if (error) {
                        console.error('Stripe Error:', error);
                        throw new Error(error.message);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message || 'An error occurred. Please try again.');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalHTML;
                }
            });

            // Initialize with URL parameter
            initializePlan();
        });
    </script>
    <!-- ========================================== -->
<!-- CabinPulse Custom Consent Manager (Start)  -->
<!-- ========================================== -->

<style>
/* --- Custom Consent Styles --- */
:root {
  /* Mapped to CabinPulse Brand Colors */
  --cp-highlight: #e94560;       /* Your Highlight/Action Color */
  --cp-highlight-hover: #d33b52; /* Slightly darker for hover state */
  --cp-bg-panel: #16213e;        /* Your Secondary Color (Cards/Modals) */
  --cp-bg-dark: #1a1a2e;         /* Your Primary Color (Backgrounds) */
  --cp-text: #ffffff;
  --cp-text-muted: rgba(255, 255, 255, 0.7);
  --cp-border: rgba(255, 255, 255, 0.1);
}

#cp-consent-container {
  font-family: 'Poppins', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  color: var(--cp-text);
  z-index: 999999; /* Max z-index to stay on top */
  position: relative;
}

/* 1. The Bottom Banner */
#cp-consent-banner {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 1000px;
  /* Using your primary color with transparency for glassmorphism */
  background: rgba(26, 26, 46, 0.95); 
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--cp-border);
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  display: none; /* Hidden by default, JS shows it */
  flex-direction: column;
  gap: 20px;
  align-items: center;
}

@media (min-width: 768px) {
  #cp-consent-banner {
    flex-direction: row;
    justify-content: space-between;
    text-align: left;
  }
}

.cp-banner-content h3 {
  font-size: 16px;
  font-weight: 600;
  margin: 0 0 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--cp-text);
}

.cp-banner-content p {
  font-size: 13px;
  color: var(--cp-text-muted);
  margin: 0;
  max-width: 600px;
  line-height: 1.6;
}

.cp-btn-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

/* Button Styles */
.cp-btn {
  padding: 10px 24px;
  border-radius: 50px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
  outline: none;
  font-family: 'Poppins', sans-serif;
}

/* Primary Button (Pink/Red Highlight) */
.cp-btn-primary {
  background: var(--cp-highlight);
  color: #ffffff;
  box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
}

.cp-btn-primary:hover {
  background: var(--cp-highlight-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(233, 69, 96, 0.5);
}

/* Outline Button */
.cp-btn-outline {
  background: transparent;
  border: 1px solid var(--cp-border);
  color: var(--cp-text);
}

.cp-btn-outline:hover {
  border-color: var(--cp-text);
  background: rgba(255,255,255,0.05);
}

/* 2. The Preferences Modal */
#cp-consent-modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000000;
}

.cp-modal-content {
  background: var(--cp-bg-panel); /* Uses your Secondary Color */
  width: 90%;
  max-width: 500px;
  border-radius: 16px;
  border: 1px solid var(--cp-border);
  box-shadow: 0 20px 60px rgba(0,0,0,0.8);
  overflow: hidden;
  animation: cpFadeIn 0.3s ease;
}

.cp-modal-header {
  padding: 20px 24px;
  background: rgba(0,0,0,0.2);
  border-bottom: 1px solid var(--cp-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cp-modal-header h3 { margin: 0; font-size: 18px; color: var(--cp-text); }

.cp-close-btn { 
  background: none; 
  border: none; 
  color: var(--cp-text-muted); 
  font-size: 24px; 
  cursor: pointer;
  transition: color 0.2s;
}
.cp-close-btn:hover { color: var(--cp-highlight); }

.cp-modal-body {
  padding: 24px;
  max-height: 60vh;
  overflow-y: auto;
}

.cp-toggle-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--cp-border);
}

.cp-toggle-row:last-child { border: none; margin-bottom: 0; padding-bottom: 0; }

.cp-toggle-info h4 { margin: 0 0 6px 0; font-size: 14px; font-weight: 600; }
.cp-toggle-info p { margin: 0; font-size: 12px; color: var(--cp-text-muted); line-height: 1.4; }

/* Switch Toggle */
.cp-switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 26px;
  flex-shrink: 0;
}

.cp-switch input { opacity: 0; width: 0; height: 0; }

.cp-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #2a2a40; /* Darker track */
  transition: .4s;
  border-radius: 34px;
  border: 1px solid var(--cp-border);
}

.cp-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .cp-slider { 
  background-color: var(--cp-highlight); 
  border-color: var(--cp-highlight);
}
input:checked + .cp-slider:before { transform: translateX(20px); }
input:disabled + .cp-slider { opacity: 0.5; cursor: not-allowed; }

.cp-modal-footer {
  padding: 20px 24px;
  background: rgba(0,0,0,0.2);
  border-top: 1px solid var(--cp-border);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

@keyframes cpFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<div id="cp-consent-container">
  <!-- Bottom Banner -->
  <div id="cp-consent-banner">
    <div class="cp-banner-content">
      <h3><i class="fas fa-cookie-bite" style="color: var(--cp-highlight);"></i> Privacy Settings</h3>
      <p>We use cookies to enhance your experience, analyze site usage, and assist in our marketing efforts. You can customize your preferences or accept all cookies.</p>
    </div>
    <div class="cp-btn-group">
      <button class="cp-btn cp-btn-outline" onclick="cpConsent.openModal()">Preferences</button>
      <button class="cp-btn cp-btn-primary" onclick="cpConsent.acceptAll()">Accept All</button>
    </div>
  </div>

  <!-- Preferences Modal -->
  <div id="cp-consent-modal">
    <div class="cp-modal-content">
      <div class="cp-modal-header">
        <h3>Cookie Preferences</h3>
        <button class="cp-close-btn" onclick="cpConsent.closeModal()">&times;</button>
      </div>
      <div class="cp-modal-body">
        
        <!-- Essential -->
        <div class="cp-toggle-row">
          <div class="cp-toggle-info">
            <h4>Strictly Necessary</h4>
            <p>Required for the website to function (e.g., login, cart). Cannot be disabled.</p>
          </div>
          <label class="cp-switch">
            <input type="checkbox" checked disabled>
            <span class="cp-slider"></span>
          </label>
        </div>

        <!-- Analytics -->
        <div class="cp-toggle-row">
          <div class="cp-toggle-info">
            <h4>Analytics</h4>
            <p>Help us understand how the site is used (Clarity, Mouseflow).</p>
          </div>
          <label class="cp-switch">
            <input type="checkbox" id="cp-opt-analytics">
            <span class="cp-slider"></span>
          </label>
        </div>

        <!-- Marketing -->
        <div class="cp-toggle-row">
          <div class="cp-toggle-info">
            <h4>Marketing</h4>
            <p>Used for ads and conversion tracking (Facebook, Google, Bing).</p>
          </div>
          <label class="cp-switch">
            <input type="checkbox" id="cp-opt-marketing">
            <span class="cp-slider"></span>
          </label>
        </div>

      </div>
      <div class="cp-modal-footer">
        <button class="cp-btn cp-btn-outline" onclick="cpConsent.rejectAll()">Reject All</button>
        <button class="cp-btn cp-btn-primary" onclick="cpConsent.savePreferences()">Save Preferences</button>
      </div>
    </div>
  </div>
</div>

<script>
/* --- Custom Consent Logic Engine --- */
const cpConsent = (function() {
  
  // CONFIGURATION: Add your IDs here
  const config = {
    googleAds: 'AW-17117116213',
    fbPixel: '491964136205687',
    clarity: 'rzeoobm96j',
    bing: '97188751',
    mouseflow: '61e5b084-381f-4246-be67-cb4704cb544b'
  };

  const COOKIE_NAME = 'cabinpulse_consent_v1';
  
  // DOM Elements
  const banner = document.getElementById('cp-consent-banner');
  const modal = document.getElementById('cp-consent-modal');
  const checkAnalytics = document.getElementById('cp-opt-analytics');
  const checkMarketing = document.getElementById('cp-opt-marketing');

  // 1. Check for existing consent
  function init() {
    const saved = localStorage.getItem(COOKIE_NAME);
    if (saved) {
      const preferences = JSON.parse(saved);
      runScripts(preferences);
    } else {
      showBanner();
    }
  }

  // 2. UI Actions
  function showBanner() { banner.style.display = 'flex'; }
  function hideBanner() { banner.style.display = 'none'; }
  function openModal() { 
    modal.style.display = 'flex'; 
    // Load current checkboxes based on existing state or default to false
    const saved = localStorage.getItem(COOKIE_NAME);
    if(saved) {
      const prefs = JSON.parse(saved);
      checkAnalytics.checked = prefs.analytics;
      checkMarketing.checked = prefs.marketing;
    }
  }
  function closeModal() { modal.style.display = 'none'; }

  // 3. User Decisions
  function acceptAll() {
    const prefs = { necessary: true, analytics: true, marketing: true };
    save(prefs);
  }

  function rejectAll() {
    const prefs = { necessary: true, analytics: false, marketing: false };
    save(prefs);
  }

  function savePreferences() {
    const prefs = {
      necessary: true,
      analytics: checkAnalytics.checked,
      marketing: checkMarketing.checked
    };
    save(prefs);
  }

  function save(prefs) {
    localStorage.setItem(COOKIE_NAME, JSON.stringify(prefs));
    hideBanner();
    closeModal();
    runScripts(prefs);
  }

  // 4. The Script Loader (The Engine)
  function runScripts(prefs) {
    console.log('CabinPulse Consent:', prefs);

    // --- ANALYTICS SCRIPTS (Clarity, Mouseflow) ---
    if (prefs.analytics) {
      // Load Clarity
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", config.clarity);

      // Load Mouseflow
      var mf = document.createElement("script");
      mf.type = "text/javascript"; mf.defer = true;
      mf.src = "//cdn.mouseflow.com/projects/" + config.mouseflow + ".js";
      document.getElementsByTagName("head")[0].appendChild(mf);
    }

    // --- MARKETING SCRIPTS (Google, FB, Bing) ---
    if (prefs.marketing) {
      // 1. Google Ads (GTAG)
      var gas = document.createElement('script');
      gas.async = true;
      gas.src = "https://www.googletagmanager.com/gtag/js?id=" + config.googleAds;
      document.head.appendChild(gas);
      
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', config.googleAds);

      // 2. Facebook Pixel
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', config.fbPixel);
      fbq('track', 'PageView');

      // 3. Bing / Microsoft UET
      (function(w,d,t,r,u){var f,n,i;w[u]=w[u]||[],f=function(){var o={ti:config.bing, enableAutoSpaTracking: true};o.q=w[u],w[u]=new UET(o),w[u].push("pageLoad")},n=d.createElement(t),n.src=r,n.async=1,n.onload=n.onreadystatechange=function(){var s=this.readyState;s&&s!=="loaded"&&s!=="complete"||(f(),n.onload=n.onreadystatechange=null)},i=d.getElementsByTagName(t)[0],i.parentNode.insertBefore(n,i)})(window,document,"script","//bat.bing.com/bat.js","uetq");
    }
  }

  // Public API
  return {
    init: init,
    openModal: openModal,
    closeModal: closeModal,
    acceptAll: acceptAll,
    rejectAll: rejectAll,
    savePreferences: savePreferences
  };
})();

// Initialize on Load
document.addEventListener("DOMContentLoaded", function() {
  cpConsent.init();
});
</script>

<!-- ========================================== -->
<!-- CabinPulse Custom Consent Manager (End)    -->
<!-- ========================================== -->
</body>
</html>