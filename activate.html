<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinPulse - Activate Your Device</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --cta-color: #ffffff;
            --accent-color: #0f3460;
            --highlight-color: #e94560;
            --text-color: #ffffff;
            --dark-text-color: #000000;
            --transition-duration: 0.5s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 25px;
        }

        /* Trust Banner */
        .trust-banner {
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.95) 0%, rgba(233, 69, 96, 0.1) 100%);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(233, 69, 96, 0.2);
            padding: 5px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .trust-banner-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 48px;
            flex-wrap: wrap;
        }

        .trust-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0.95;
        }

        .trust-item i {
            color: var(--highlight-color);
            font-size: 1rem;
        }

        /* Header */
        header {
            background-color: rgba(26, 26, 46, 0.98);
            backdrop-filter: blur(12px);
            padding: 20px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(233, 69, 96, 0.2);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-container img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }

        .logo-container h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Main Content */
        .activate-wrapper {
            padding: 60px 0;
            min-height: calc(100vh - 200px);
        }

        .activate-container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Retailer Selection View */
        .retailer-selection {
            display: block;
        }

        .retailer-selection.hidden {
            display: none;
        }

        .activate-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .activate-header h2 {
            font-size: 3rem;
            font-weight: 700;
            color: var(--highlight-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .activate-header h2 i {
            font-size: 3.5rem;
        }

        .activate-description {
            font-size: 1.3rem;
            opacity: 0.9;
            color: var(--text-color);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.8;
        }

        /* Retailer Selection Grid */
        .retailer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            margin-top: 40px;
        }

        .retailer-option {
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.4) 0%, rgba(233, 69, 96, 0.05) 100%);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 24px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: var(--text-color);
            display: block;
        }

        .retailer-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .retailer-option:hover::before {
            opacity: 1;
        }

        .retailer-option:hover {
            border-color: var(--highlight-color);
            transform: translateY(-8px);
            box-shadow: 0 16px 32px rgba(233, 69, 96, 0.3);
        }

        .retailer-logo {
            height: 80px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .retailer-logo img {
            max-height: 100%;
            max-width: 200px;
            object-fit: contain;
        }

        .retailer-logo i {
            font-size: 4rem;
            color: var(--highlight-color);
        }

        .retailer-name {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .retailer-tagline {
            font-size: 1rem;
            opacity: 0.8;
            position: relative;
            z-index: 1;
            color: var(--text-color);
        }

        /* Special styling for CabinPulse option */
        .retailer-option.featured {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.15) 0%, rgba(15, 52, 96, 0.4) 100%);
            border-color: rgba(233, 69, 96, 0.5);
        }

        .retailer-option.featured::after {
            content: 'Direct Purchase';
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--highlight-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Activation Flow */
        .activation-flow {
            display: none;
        }

        .activation-flow.active {
            display: block;
        }

        /* Purchase Form */
        .purchase-form {
            background: linear-gradient(135deg, var(--primary-color) 0%, rgba(15,52,96,0.8) 100%);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
            border: 2px solid rgba(233,69,96,0.3);
            position: relative;
            overflow: hidden;
        }

        .purchase-form::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(233,69,96,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            z-index: 0;
            pointer-events: none;
        }

        .purchase-form > * {
            position: relative;
            z-index: 1;
        }

        .form-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .form-header h2 {
            font-size: 1.8rem;
            color: var(--highlight-color);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .form-header i {
            font-size: 2.5rem;
        }

        /* Step Indicators */
        .step-indicators {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 40px;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .step-indicator.active {
            opacity: 1;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(233, 69, 96, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--highlight-color);
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-icon {
            background: var(--highlight-color);
            color: white;
            transform: scale(1.1);
        }

        .step-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Form Steps */
        .form-step {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .form-step.active {
            display: block;
            opacity: 1;
        }

        .step-content {
            margin-bottom: 32px;
        }

        .step-title {
            font-size: 1.8rem;
            color: var(--highlight-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            font-weight: 700;
            gap: 12px;
        }

        .step-description {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        /* Activation Code Input */
        .activation-input-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .activation-input {
            width: 100%;
            padding: 20px 24px;
            border: 3px solid rgba(233, 69, 96, 0.3);
            border-radius: 16px;
            background: rgba(15, 52, 96, 0.3);
            color: var(--text-color);
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 4px;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }

        .activation-input:focus {
            outline: none;
            border-color: var(--highlight-color);
            background: rgba(15, 52, 96, 0.5);
            box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.2);
        }

        .activation-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-family: 'Poppins', sans-serif;
            text-transform: none;
            letter-spacing: normal;
        }

        .activation-input.valid {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .activation-input.invalid {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .activation-help {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 24px;
        }

        .validation-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            font-weight: 600;
            min-height: 24px;
        }

        .validation-status.success {
            color: #4CAF50;
        }

        .validation-status.error {
            color: #ff4444;
        }

        .validation-status.loading {
            color: var(--highlight-color);
        }

        /* Plan Selection */
        .plan-selection {
            max-width: 600px;
            margin: 0 auto;
        }

        .device-image-section {
            text-align: center;
            margin-bottom: 32px;
        }

        .plan-device-image {
            width: 200px;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 8px 24px rgba(0, 0, 0, 0.3));
        }

        .plan-content-mobile {
            width: 100%;
        }

        .step-title.desktop-only {
            display: flex;
        }

        .step-description.desktop-only {
            display: block;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block !important;
            }

            .step-title.mobile-only {
                display: flex !important;
            }

            .step-title.desktop-only,
            .step-description.desktop-only {
                display: none;
            }

            .device-image-section {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 24px;
            }

            .plan-device-image {
                width: 80px;
                flex-shrink: 0;
            }

            .plan-content-wrapper {
                flex: 1;
                text-align: left;
            }

            .plan-toggle {
                width: 100%;
            }

            .plan-details {
                margin-top: 24px;
            }
        }

        .plan-toggle {
            position: relative;
            display: flex;
            background: rgba(15,52,96,0.4);
            border-radius: 60px;
            padding: 8px;
            border: 3px solid rgba(233,69,96,0.3);
            margin-bottom: 40px;
        }

        .plan-option {
            flex: 1;
            padding: 16px 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.7;
            z-index: 2;
            position: relative;
            text-align: center;
        }

        .plan-option.active {
            opacity: 1;
            color: #fff;
        }

        .plan-slider {
            position: absolute;
            top: 8px;
            left: 8px;
            width: calc(50% - 8px);
            height: calc(100% - 16px);
            background: var(--highlight-color);
            border-radius: 50px;
            transition: transform 0.3s ease;
            z-index: 1;
        }

        .plan-slider.three-year {
            transform: translateX(100%);
        }

        .savings-badge {
            position: absolute;
            top: -8px;
            right: 8px;
            background: var(--highlight-color);
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
            z-index: 3;
            animation: gentleWiggle 2s infinite ease-in-out;
        }

        .savings-badge.activated {
            animation: none;
            transform: scale(1.05);
        }

        @keyframes gentleWiggle {
            0% { transform: rotate(-2deg) scale(1); }
            50% { transform: rotate(2deg) scale(1.05); }
            100% { transform: rotate(-2deg) scale(1); }
        }

        .plan-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 32px;
        }

        .plan-card {
            background: rgba(15, 52, 96, 0.3);
            border: 2px solid rgba(233, 69, 96, 0.2);
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .plan-card:hover {
            border-color: rgba(233, 69, 96, 0.4);
            transform: translateY(-2px);
        }

        .plan-card.active {
            border-color: var(--highlight-color);
            background: rgba(15, 52, 96, 0.5);
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(233, 69, 96, 0.3);
        }

        .plan-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--highlight-color);
            margin-bottom: 8px;
        }

        .plan-period {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 16px;
        }

        .plan-total {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .plan-savings {
            background: rgba(233, 69, 96, 0.2);
            color: var(--highlight-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
        }

        /* Selection Options */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .selection-option {
            background: rgba(15, 52, 96, 0.4);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .selection-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .selection-option:hover::before,
        .selection-option.selected::before {
            opacity: 1;
        }

        .selection-option:hover,
        .selection-option.selected {
            border-color: var(--highlight-color);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(233, 69, 96, 0.3);
        }

        .selection-option i {
            font-size: 3rem;
            color: var(--highlight-color);
            margin-bottom: 16px;
            display: block;
            position: relative;
            z-index: 1;
        }

        .option-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .option-description {
            font-size: 0.9rem;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }

        /* Form Inputs */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: var(--highlight-color);
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
            background: rgba(15, 52, 96, 0.3);
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--highlight-color);
            background: rgba(15, 52, 96, 0.5);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Validation Styles */
        .form-group input.invalid {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .validation-message {
            color: #ff4444;
            font-size: 0.8rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-error-message {
            color: #ff4444;
            padding: 10px;
            margin-top: 10px;
            background-color: rgba(255, 68, 68, 0.1);
            border-radius: 5px;
        }

        /* Info Box */
        .info-box {
            background: rgba(15, 52, 96, 0.5);
            border: 1px solid var(--highlight-color);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-box i {
            color: var(--highlight-color);
            font-size: 1.2rem;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .info-box p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0;
        }

        /* Buttons */
        .button-container {
            display: flex;
            gap: 16px;
            margin-top: 40px;
        }

        .btn {
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--highlight-color);
            color: white;
            flex: 2;
        }

        .btn-primary:hover:not(:disabled) {
            background: #ff5a7c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-primary:disabled {
            background: rgba(233, 69, 96, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border: 2px solid rgba(233, 69, 96, 0.5);
            flex: 1;
        }

        .btn-secondary:hover {
            border-color: var(--highlight-color);
            background: rgba(233, 69, 96, 0.1);
        }

        /* Loading State */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Plan Summary */
        .plan-summary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, rgba(15, 52, 96, 0.8) 100%);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(233, 69, 96, 0.3);
            position: relative;
            overflow: hidden;
        }

        .plan-summary::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(233, 69, 96, 0.05) 0%, transparent 70%);
            transform: rotate(45deg);
            z-index: 0;
            pointer-events: none;
        }

        .plan-summary > * {
            position: relative;
            z-index: 1;
        }

        .plan-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .plan-summary-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .plan-summary-title h2 {
            font-size: 1.6rem;
            color: var(--highlight-color);
            margin: 0;
        }

        .plan-summary-title i {
            font-size: 1.8rem;
            color: var(--highlight-color);
        }

        /* Total Summary */
        .total-summary {
            background: rgba(15, 52, 96, 0.3);
            border: 1px solid rgba(233, 69, 96, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 24px;
        }

        /* Compact Plan Summary Styles */
        .compact-product-image {
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
        }

        .price-label-compact {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Plan Toggle - Compact Version */
        .compact-plan-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .compact-toggle {
            position: relative;
            display: flex;
            background: rgba(15,52,96,0.4);
            border-radius: 50px;
            padding: 4px;
            border: 2px solid rgba(233,69,96,0.3);
        }

        .compact-toggle-option {
            padding: 8px 16px;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
            z-index: 2;
            position: relative;
            white-space: nowrap;
        }

        .compact-toggle-option.active {
            opacity: 1;
            color: #fff;
        }

        .compact-toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: var(--highlight-color);
            border-radius: 40px;
            transition: transform 0.3s ease;
            z-index: 1;
        }

        .compact-toggle-slider.three-year {
            transform: translateX(100%);
        }

        .compact-savings-indicator {
            position: absolute;
            top: -6px;
            right: -12px;
            background: var(--highlight-color);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 700;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(233, 69, 96, 0.4);
            z-index: 3;
            animation: gentleWiggle 2s infinite ease-in-out;
        }

        .compact-savings-indicator.activated {
            animation: none;
            transform: scale(1.05);
        }

        /* Pricing Display */
        .pricing-horizontal {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .pricing-vertical {
            text-align: center;
        }

        .price-main {
            display: flex;
            align-items: baseline;
            gap: 8px;
            justify-content: center;
        }

        .price-large {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--cta-color);
            line-height: 1;
        }

        .price-period {
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .price-label-compact {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Features List - Compact */
        .features-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
        }

        .feature-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(15, 52, 96, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid rgba(233, 69, 96, 0.2);
        }

        .feature-badge i {
            color: var(--highlight-color);
            font-size: 0.9rem;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .total-row:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--highlight-color);
        }

        .total-label {
            opacity: 0.8;
        }

        .total-amount {
            font-weight: 600;
        }

        /* Footer */
        footer {
            background-color: var(--secondary-color);
            text-align: center;
            padding: 32px 0;
            border-top: 1px solid rgba(233, 69, 96, 0.2);
        }

        /* Loading Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .retailer-option {
            animation: fadeIn 0.6s ease-out forwards;
            opacity: 0;
        }

        .retailer-option:nth-child(1) { animation-delay: 0.1s; }
        .retailer-option:nth-child(2) { animation-delay: 0.2s; }
        .retailer-option:nth-child(3) { animation-delay: 0.3s; }
        .retailer-option:nth-child(4) { animation-delay: 0.4s; }

        /* Responsive Design */
        @media (max-width: 968px) {
            .retailer-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 24px;
            }

            .activate-header h2 {
                font-size: 2.5rem;
            }

            .activate-description {
                font-size: 1.1rem;
            }

            .plan-details {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .plan-summary-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .pricing-horizontal {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 16px;
            }

            .features-compact {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .activate-wrapper {
                padding: 40px 0;
            }

            .activate-header h2 {
                font-size: 2rem;
                flex-direction: column;
                gap: 12px;
            }

            .activate-header h2 i {
                font-size: 2.5rem;
            }

            .activate-description {
                font-size: 1rem;
            }

            .retailer-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .retailer-option {
                padding: 32px 24px;
            }

            .retailer-logo {
                height: 60px;
            }

            .retailer-name {
                font-size: 1.4rem;
            }

            .trust-banner-content {
                gap: 20px;
            }

            .info-box {
                margin-top: 40px;
                padding: 20px;
                gap: 12px;
            }

            .purchase-form {
                padding: 24px;
                border-radius: 20px;
            }

            .selection-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .selection-option {
                padding: 24px 20px;
            }

            .step-indicators {
                gap: 16px;
            }

            .button-container {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .activation-input {
                font-size: 1.2rem;
                padding: 16px 20px;
            }
        }

        @media (max-width: 480px) {
            .activate-header {
                margin-bottom: 40px;
            }

            .activate-header h2 {
                font-size: 1.8rem;
            }

            .retailer-option.featured::after {
                font-size: 0.7rem;
                padding: 3px 8px;
            }

            .plan-summary-title {
                flex-direction: column;
                gap: 8px;
            }

            .plan-summary-title h2 {
                font-size: 1.2rem;
            }

            .activation-input {
                font-size: 1rem;
                letter-spacing: 2px;
            }

            #step-2 .plan-option {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .compact-toggle {
                width: 100%;
            }

            .compact-toggle-option {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .compact-savings-indicator {
                font-size: 0.55rem;
                padding: 2px 4px;
            }

            .pricing-horizontal {
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Trust Banner -->
    <div class="trust-banner">
        <div class="trust-banner-content">
            <div class="trust-item">
                <i class="fas fa-undo"></i>
                <span>Free Returns</span>
            </div>
            <div class="trust-item">
                <i class="fas fa-check-circle"></i>
                <span>3-Year Warranty</span>
            </div>
            <div class="trust-item">
                <i class="fas fa-star"></i>
                <span>5-Star Support</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo-container">
                <img src="cpicon.png" alt="CabinPulse Logo">
                <h1>CabinPulse</h1>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="activate-wrapper">
        <div class="container">
            <div class="activate-container">
                <!-- Retailer Selection -->
                <div class="retailer-selection" id="retailer-selection">
                    <div class="activate-header">
                        <h2>
                            <i class="fas fa-rocket"></i>
                            Activate Your Device
                        </h2>
                        <p class="activate-description">
                            Where did you purchase your CabinPulse device?
                        </p>
                    </div>

                    <div class="retailer-grid">
                        <!-- CabinPulse.com Option -->
                        <a href="https://dashboard.cabinpulse.com" class="retailer-option featured">
                            <div class="retailer-logo">
                                <img src="cpicon.png" alt="CabinPulse">
                            </div>
                            <div class="retailer-name">CabinPulse.com</div>
                            <div class="retailer-tagline">Already have an account</div>
                        </a>

                        <!-- Amazon.ca Option -->
                        <div class="retailer-option" data-retailer="amazon">
                            <div class="retailer-logo">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" alt="Amazon">
                            </div>
                            <div class="retailer-name">Amazon.ca</div>
                            <div class="retailer-tagline">Purchased on Amazon</div>
                        </div>

                        <!-- Walmart.ca Option -->
                        <div class="retailer-option" data-retailer="walmart">
                            <div class="retailer-logo">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Walmart_logo_%282008%29.svg/1598px-Walmart_logo_%282008%29.svg.png" alt="Walmart">
                            </div>
                            <div class="retailer-name">Walmart.ca</div>
                            <div class="retailer-tagline">Purchased at Walmart</div>
                        </div>

                        <!-- Other Retailer Option -->
                        <div class="retailer-option" data-retailer="other">
                            <div class="retailer-logo">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="retailer-name">Other Retailer</div>
                            <div class="retailer-tagline">Purchased elsewhere</div>
                        </div>
                    </div>

                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <p>
                            <strong>Need help?</strong> If you're having trouble activating your device, visit 
                            <a href="https://cabinpulse.com" style="color: var(--highlight-color);">CabinPulse.com</a> 
                            for Live Chat support or email support@cabinpulse.com
                        </p>
                    </div>
                </div>

                <!-- Activation Flow -->
                <div class="activation-flow" id="activation-flow">
                    <!-- Purchase Form -->
                    <div class="purchase-form">
                        <div class="form-header">
                            <h2>
                                <i class="fas fa-wifi"></i>
                                Activate Your Device
                            </h2>
                            <p style="opacity: 0.8; font-size: 1rem; margin-top: 8px;">
                                Enter your activation code to start monitoring your property
                            </p>
                        </div>

                        <!-- Step Indicators -->
                        <div class="step-indicators">
                            <div class="step-indicator active" id="indicator-1">
                                <div class="step-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <div class="step-label">Activate</div>
                            </div>
                            <div class="step-indicator" id="indicator-2">
                                <div class="step-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="step-label">Plan</div>
                            </div>
                            <div class="step-indicator" id="indicator-3">
                                <div class="step-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="step-label">Account</div>
                            </div>
                            <div class="step-indicator" id="indicator-4">
                                <div class="step-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="step-label">Confirm</div>
                            </div>
                        </div>

                        <!-- Form Steps -->
                        <form id="activationForm">
                            <!-- Step 1: Activation Code -->
                            <div class="form-step active" id="step-1">
                                <div class="step-content">
                                    <div class="step-title">
                                        <i class="fas fa-key"></i>
                                        Activation Code
                                    </div>
                                    <div class="step-description">
                                        Enter the 8-character activation code found on the activation card that came with your device.
                                    </div>

                                    <div class="activation-input-container">
                                        <input 
                                            type="text" 
                                            id="activation-code" 
                                            class="activation-input" 
                                            placeholder="ABCD1234"
                                            maxlength="8"
                                            autocomplete="off"
                                            spellcheck="false"
                                        >
                                        <div class="activation-help">
                                            Check the activation card included in your device packaging
                                        </div>
                                        <div class="validation-status" id="validation-status"></div>
                                    </div>

                                    <div class="info-box">
                                        <i class="fas fa-question-circle"></i>
                                        <p><strong>Can't find your code?</strong> Check inside your device's packaging for a separate activation card. The code is 8 alphanumeric characters (letters and numbers).</p>
                                    </div>
                                </div>

                                <div class="button-container">
                                    <button type="button" class="btn btn-secondary" onclick="backToRetailerSelection()">
                                        <i class="fas fa-arrow-left"></i>
                                        Back
                                    </button>
                                    <button type="button" class="btn btn-primary" id="step1-continue" onclick="nextStep()" disabled>
                                        Continue
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 2: Plan Selection -->
                            <div class="form-step" id="step-2">
                                <div class="step-content">
                                    <div class="step-title">
                                        <i class="fas fa-calendar-alt"></i>
                                        Choose Your Plan
                                    </div>
                                    <div class="step-description">
                                        Select your monitoring plan duration. You can always change or cancel later.
                                    </div>

                                    <div class="plan-selection">
                                        <div class="plan-toggle">
                                            <div class="plan-option active" data-plan="1" id="toggle-1">1 Year Plan</div>
                                            <div class="plan-option" data-plan="3" id="toggle-3">
                                                3 Year Plan
                                                <span class="savings-badge" id="savings-indicator">Save 29%!</span>
                                            </div>
                                            <div class="plan-slider" id="toggle-slider"></div>
                                        </div>

                                        <div class="plan-details">
                                            <div class="plan-card active" id="plan-1">
                                                <div class="plan-price">$14<span style="font-size: 1.5rem; opacity: 0.7;">/mo</span></div>
                                                <div class="plan-period">billed annually (CAD)</div>
                                                <div class="plan-total">$168 CAD total for 1 year</div>
                                            </div>
                                            <div class="plan-card" id="plan-3">
                                                <div class="plan-price">$10<span style="font-size: 1.5rem; opacity: 0.7;">/mo</span></div>
                                                <div class="plan-period">billed every 3 years (CAD)</div>
                                                <div class="plan-total">$360 CAD total for 3 years</div>
                                                <div class="plan-savings">Save $144!</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-box">
                                        <i class="fas fa-info-circle"></i>
                                        <p>All plans include unlimited alerts, 24/7 monitoring, mobile app access, and customer support. No automatic renewal - we'll remind you before your plan expires.</p>
                                    </div>
                                </div>

                                <div class="button-container">
                                    <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                        <i class="fas fa-arrow-left"></i>
                                        Back
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        Continue
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Account -->
                            <div class="form-step" id="step-3">
                                <div class="step-content">
                                    <div class="step-title">
                                        <i class="fas fa-user"></i>
                                        Account Setup
                                    </div>
                                    <div class="step-description">
                                        Do you have an existing CabinPulse account?
                                    </div>

                                    <div class="selection-grid">
                                        <div class="selection-option" data-type="new">
                                            <i class="fas fa-user-plus"></i>
                                            <div class="option-title">New Customer</div>
                                            <div class="option-description">This is my first CabinPulse device</div>
                                        </div>
                                        <div class="selection-option" data-type="existing">
                                            <i class="fas fa-sign-in-alt"></i>
                                            <div class="option-title">Existing Customer</div>
                                            <div class="option-description">I already have a CabinPulse account</div>
                                        </div>
                                    </div>

                                    <!-- New User Form -->
                                    <div id="new-user-form" class="account-form" style="display: none;">
                                        <div class="info-box">
                                            <i class="fas fa-info-circle"></i>
                                            <p>Welcome! We'll send you an email with your login credentials once your purchase is complete.</p>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="name">
                                                <i class="fas fa-user"></i>
                                                Full Name
                                            </label>
                                            <input type="text" id="name" name="name" placeholder="John Doe" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="email">
                                                <i class="fas fa-envelope"></i>
                                                Email Address
                                            </label>
                                            <input type="email" id="email" name="email" placeholder="hello@website.com" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="phone">
                                                <i class="fas fa-mobile-alt"></i>
                                                Mobile Number for Alerts
                                            </label>
                                            <input type="tel" id="phone" name="phone" placeholder="555-555-5555" required>
                                            <div class="info-box" style="margin-top: 12px;">
                                                <i class="fas fa-bell"></i>
                                                <p>You'll receive text alerts about your property's status. Alert preferences can be customized anytime.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Existing User Form -->
                                    <div id="existing-user-form" class="account-form" style="display: none;">
                                        <div class="form-group">
                                            <label for="login-email">
                                                <i class="fas fa-envelope"></i>
                                                Email Address
                                            </label>
                                            <input type="email" id="login-email" name="login-email" placeholder="hello@website.com" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="login-password">
                                                <i class="fas fa-lock"></i>
                                                Password
                                            </label>
                                            <input type="password" id="login-password" name="login-password" placeholder="**********" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="button-container">
                                    <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                        <i class="fas fa-arrow-left"></i>
                                        Back
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        Continue
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 4: Confirmation -->
                            <div class="form-step" id="step-4">
                                <div class="step-content">
                                    <div class="step-title">
                                        <i class="fas fa-check-circle"></i>
                                        Review & Activate
                                    </div>
                                    <div class="step-description">
                                        Review your plan selection and complete your device activation.
                                    </div>

                                    <!-- Compact Plan Summary -->
                                    <div class="plan-summary">
                                        <div class="plan-summary-header">
                                            <div class="plan-summary-title">
                                                <img src="front.png" alt="CabinPulse Device" class="compact-product-image">
                                                <div>
                                                    <h2>CabinPulse Monitoring</h2>
                                                    <div class="price-label-compact" id="confirm-plan-duration">1-Year Plan</div>
                                                </div>
                                            </div>

                                            <!-- Compact Plan Toggle -->
                                            <div class="compact-plan-toggle">
                                                <div class="compact-toggle">
                                                    <div class="compact-toggle-option active" data-plan="1" id="confirm-toggle-1">1 Year</div>
                                                    <div class="compact-toggle-option" data-plan="3" id="confirm-toggle-3">
                                                        3 Years
                                                        <span class="compact-savings-indicator" id="confirm-savings-indicator">Save 29%!</span>
                                                    </div>
                                                    <div class="compact-toggle-slider" id="confirm-toggle-slider"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pricing Display -->
                                        <div class="pricing-horizontal">
                                            <div class="pricing-vertical">
                                                <div class="price-main">
                                                    <div class="price-large">
                                                        $<span id="confirm-monthly-price">14</span><span class="price-period">/mo</span>
                                                    </div>
                                                </div>
                                                <div class="price-label-compact">
                                                    <span id="confirm-price-label">billed annually</span> (CAD)
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Compact Features -->
                                        <div class="features-compact">
                                            <div class="feature-badge">
                                                <i class="fas fa-wifi"></i>
                                                <span>No WiFi Required</span>
                                            </div>
                                            <div class="feature-badge">
                                                <i class="fas fa-bell"></i>
                                                <span>Instant Alerts</span>
                                            </div>
                                            <div class="feature-badge">
                                                <i class="fas fa-shield-alt"></i>
                                                <span>30-Day Guarantee</span>
                                            </div>
                                        </div>

                                        <!-- Total Summary -->
                                        <div class="total-summary">
                                            <div class="total-row">
                                                <span class="total-label">Monitoring Plan</span>
                                                <span class="total-amount" id="confirm-subscription-cost">$168 CAD/year</span>
                                            </div>
                                            <div class="total-row">
                                                <span>Total Due Today</span>
                                                <span id="confirm-total-due">$168 CAD</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-box">
                                        <i class="fas fa-microchip"></i>
                                        <p><strong>Device Activation Code:</strong> <span id="confirm-device-code" style="font-family: 'Courier New', monospace; color: var(--highlight-color);">ABCD1234</span></p>
                                    </div>

                                    <div class="info-box">
                                        <i class="fas fa-gift"></i>
                                        <p><strong>Have a discount code?</strong> You'll be able to apply it on the next screen.</p>
                                    </div>

                                    <div class="info-box">
                                        <i class="fas fa-info-circle"></i>
                                        <p>You can choose whether to renew when your plan ends - you won't be charged automatically. We'll send you a reminder before your renewal date.</p>
                                    </div>

                                    <p style="font-size: 0.9rem; opacity: 0.8; text-align: center; margin-top: 24px;">
                                        By clicking "Complete Purchase", you agree to our 
                                        <a href="https://cabinpulse.com/legal.html" style="color: var(--highlight-color);">Terms of Service</a> 
                                        and 
                                        <a href="https://cabinpulse.com/legal.html" style="color: var(--highlight-color);">Privacy Policy</a>.
                                    </p>
                                </div>

                                <div class="button-container">
                                    <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                        <i class="fas fa-arrow-left"></i>
                                        Back
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="activation-button">
                                        <i class="fas fa-lock"></i>
                                        Complete Purchase
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 CabinPulse</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentStep = 1;
            let isLoginMode = false;
            let isAuthenticated = false;
            let userId = null;
            let authToken = null;
            let selectedPlan = '1';
            let activationCode = '';
            let deviceInfo = {};
            let selectedRetailer = '';

            // Get retailer from URL parameter if present
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('retailer')) {
                selectedRetailer = urlParams.get('retailer');
                showActivationFlow(selectedRetailer);
            }

            // Add click handlers for retailer options (except CabinPulse.com)
            const retailerOptions = document.querySelectorAll('.retailer-option[data-retailer]');
            
            retailerOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectedRetailer = this.getAttribute('data-retailer');
                    
                    // Add a brief animation effect
                    this.style.transform = 'scale(0.95)';
                    
                    setTimeout(() => {
                        showActivationFlow(selectedRetailer);
                    }, 200);
                });
            });

            function showActivationFlow(retailer) {
                selectedRetailer = retailer;
                document.getElementById('retailer-selection').classList.add('hidden');
                document.getElementById('activation-flow').classList.add('active');
            }

            window.backToRetailerSelection = function() {
                document.getElementById('retailer-selection').classList.remove('hidden');
                document.getElementById('activation-flow').classList.remove('active');
                currentStep = 1;
                resetForm();
            };

            function resetForm() {
                // Reset step indicators
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    if (index === 0) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                });

                // Reset form steps
                document.querySelectorAll('.form-step').forEach((step, index) => {
                    if (index === 0) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });

                // Clear form inputs
                document.getElementById('activation-code').value = '';
                document.getElementById('activation-code').className = 'activation-input';
                document.getElementById('validation-status').innerHTML = '';
                document.getElementById('step1-continue').disabled = true;
            }

            // Plan toggle functionality
            const planOptions = document.querySelectorAll('.plan-option');
            const planSlider = document.querySelector('.plan-slider');
            const savingsIndicator = document.querySelector('.savings-badge');
            const planCards = document.querySelectorAll('.plan-card');

            const plans = {
                1: { 
                    price: '14', 
                    label: 'billed annually', 
                    duration: '1-Year Plan', 
                    total: '$168 CAD total',
                    amount: 168
                },
                3: { 
                    price: '10', 
                    label: 'billed every 3 years', 
                    duration: '3-Year Plan', 
                    total: '$360 CAD total',
                    amount: 360
                }
            };

            // Prevent Enter key from submitting the form
            document.getElementById('activationForm').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    return false;
                }
            });

            // Debounce function for API calls
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Validation functions
            function showFieldError(fieldId, message) {
                const field = document.getElementById(fieldId);
                const existingMessage = field.parentElement.querySelector('.validation-message');
                
                if (existingMessage) {
                    existingMessage.remove();
                }

                field.classList.add('invalid');
                
                const messageElement = document.createElement('div');
                messageElement.className = 'validation-message';
                messageElement.textContent = message;
                
                field.parentElement.appendChild(messageElement);
            }

            function clearFieldError(fieldId) {
                const field = document.getElementById(fieldId);
                const existingMessage = field.parentElement.querySelector('.validation-message');
                
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                field.classList.remove('invalid');
            }

            function showValidationError(formId, message) {
                const form = document.getElementById(formId);
                const existingError = form.querySelector('.form-error-message');
                
                if (existingError) {
                    existingError.remove();
                }

                const errorElement = document.createElement('div');
                errorElement.className = 'form-error-message';
                errorElement.textContent = message;
                
                form.appendChild(errorElement);
            }

            function clearValidationMessages(formId) {
                const form = document.getElementById(formId);
                form.querySelectorAll('.validation-message, .form-error-message').forEach(el => el.remove());
                form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            }

            // API functions
            async function checkFieldAvailability(field, value) {
                try {
                    const response = await fetch('https://cabinpulse.com/api/users/check-availability', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            [field]: value
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    return data.availability[field];
                } catch (error) {
                    console.error('Error checking availability:', error);
                    return { available: false, message: 'Error checking availability' };
                }
            }

            async function authenticateUser(email, password) {
                try {
                    const response = await fetch('https://cabinpulse.com/api/users/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email,
                            password
                        })
                    });

                    if (!response.ok) {
                        return false;
                    }

                    const data = await response.json();
                    isAuthenticated = true;
                    userId = data.userId;
                    authToken = data.token;
                    return true;
                } catch (error) {
                    console.error('Authentication error:', error);
                    return false;
                }
            }

            // Activation code input formatting and validation
            const activationInput = document.getElementById('activation-code');
            const validationStatus = document.getElementById('validation-status');

            activationInput.addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                if (value.length > 8) {
                    value = value.substring(0, 8);
                }
                
                e.target.value = value;
                validateActivationCode(value);
            });

            async function validateActivationCode(code) {
                const continueButton = document.getElementById('step1-continue');
                
                if (code.length < 8) {
                    validationStatus.innerHTML = '';
                    activationInput.className = 'activation-input';
                    continueButton.disabled = true;
                    return;
                }

                validationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
                validationStatus.className = 'validation-status loading';

                try {
                    const response = await fetch('https://cabinpulse.com/api/validate-activation-code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            code,
                            retailer: selectedRetailer 
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok && data.valid) {
                        // Code is valid
                        activationCode = code;
                        deviceInfo = data.device;
                        validationStatus.innerHTML = '<i class="fas fa-check"></i> Code validated successfully!';
                        validationStatus.className = 'validation-status success';
                        activationInput.className = 'activation-input valid';
                        continueButton.disabled = false;
                        document.getElementById('confirm-device-code').textContent = code;
                    } else {
                        // Code is invalid - show specific error message from API
                        const errorMessage = data.message || 'Invalid activation code';
                        validationStatus.innerHTML = `<i class="fas fa-times"></i> ${errorMessage}`;
                        validationStatus.className = 'validation-status error';
                        activationInput.className = 'activation-input invalid';
                        continueButton.disabled = true;
                    }
                } catch (error) {
                    console.error('Error validating activation code:', error);
                    validationStatus.innerHTML = '<i class="fas fa-times"></i> Error validating code. Please try again.';
                    validationStatus.className = 'validation-status error';
                    activationInput.className = 'activation-input invalid';
                    continueButton.disabled = true;
                }
            }

            // Plan selection functionality
            planOptions.forEach(option => {
                option.addEventListener('click', function() {
                    selectPlan(this.dataset.plan);
                });
            });

            // Make plan cards clickable too
            planCards.forEach((card, index) => {
                card.addEventListener('click', function() {
                    const planNumber = index === 0 ? '1' : '3';
                    selectPlan(planNumber);
                });
            });

            function selectPlan(newPlan) {
                if (newPlan === selectedPlan) return;

                // Confetti for upgrade to 3-year
                if (selectedPlan === '1' && newPlan === '3') {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { x: 0.5, y: 0.3 }
                    });
                }

                selectedPlan = newPlan;
                
                planOptions.forEach(opt => opt.classList.remove('active'));
                document.getElementById(`toggle-${newPlan}`).classList.add('active');
                
                planCards.forEach(card => card.classList.remove('active'));
                document.getElementById(`plan-${newPlan}`).classList.add('active');
                
                planSlider.classList.toggle('three-year', selectedPlan === '3');
                
                if (selectedPlan === '3') {
                    savingsIndicator.textContent = "Saving 29%";
                    savingsIndicator.classList.add('activated');
                } else {
                    savingsIndicator.textContent = "Save 29%!";
                    savingsIndicator.classList.remove('activated');
                }
                
                updateConfirmationStep();
            }

            // Account type selection
            document.querySelectorAll('.selection-option[data-type]').forEach(option => {
                option.addEventListener('click', function() {
                    const type = this.dataset.type;
                    
                    document.querySelectorAll('.selection-option[data-type]').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const newUserForm = document.getElementById('new-user-form');
                    const existingUserForm = document.getElementById('existing-user-form');
                    
                    if (type === 'new') {
                        newUserForm.style.display = 'block';
                        existingUserForm.style.display = 'none';
                        isLoginMode = false;
                        
                        existingUserForm.querySelectorAll('input').forEach(input => {
                            input.required = false;
                        });
                        newUserForm.querySelectorAll('input').forEach(input => {
                            input.required = true;
                        });
                    } else {
                        newUserForm.style.display = 'none';
                        existingUserForm.style.display = 'block';
                        isLoginMode = true;
                        
                        newUserForm.querySelectorAll('input').forEach(input => {
                            input.required = false;
                        });
                        existingUserForm.querySelectorAll('input').forEach(input => {
                            input.required = true;
                        });
                    }
                    
                    scrollToAccountForm();
                });
            });

            // Real-time validation for email and phone
            document.getElementById('email')?.addEventListener('input', debounce(async function(e) {
                const email = e.target.value.trim();
                if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    const result = await checkFieldAvailability('email', email);
                    if (!result.available) {
                        showFieldError('email', result.message);
                    } else {
                        clearFieldError('email');
                    }
                }
            }, 500));

            document.getElementById('phone')?.addEventListener('input', debounce(async function(e) {
                const phone = e.target.value.trim();
                if (phone && phone.length >= 10) {
                    const result = await checkFieldAvailability('phone', phone);
                    if (!result.available) {
                        showFieldError('phone', result.message);
                    } else {
                        clearFieldError('phone');
                    }
                }
            }, 500));

            function scrollToAccountForm() {
                if (window.innerWidth <= 768) {
                    const newUserForm = document.getElementById('new-user-form');
                    const existingUserForm = document.getElementById('existing-user-form');
                    
                    const visibleForm = newUserForm.style.display === 'block' ? newUserForm : existingUserForm;
                    
                    if (visibleForm) {
                        setTimeout(() => {
                            const rect = visibleForm.getBoundingClientRect();
                            const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                            
                            if (!isVisible) {
                                const scrollOffset = rect.top - window.innerHeight * 0.7;
                                window.scrollBy({
                                    top: scrollOffset,
                                    behavior: 'smooth'
                                });
                            }
                        }, 100);
                    }
                }
            }

            // Confirmation screen plan toggle
            const confirmToggles = document.querySelectorAll('.compact-toggle-option');
            const confirmSlider = document.querySelector('.compact-toggle-slider');
            const confirmSavingsIndicator = document.querySelector('.compact-savings-indicator');
            
            confirmToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const newPlan = this.dataset.plan;
                    selectPlan(newPlan);
                    
                    // Update confirmation toggle state
                    confirmToggles.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    confirmSlider.classList.toggle('three-year', newPlan === '3');
                });
            });

            function updateConfirmationStep() {
                const planData = plans[selectedPlan];
                
                document.getElementById('confirm-plan-duration').textContent = planData.duration;
                document.getElementById('confirm-monthly-price').textContent = planData.price;
                document.getElementById('confirm-price-label').textContent = planData.label;
                document.getElementById('confirm-subscription-cost').textContent = planData.total.replace(' total', '');
                document.getElementById('confirm-total-due').textContent = `$${planData.amount} CAD`;
                
                // Update toggle state
                confirmToggles.forEach(toggle => {
                    toggle.classList.toggle('active', toggle.dataset.plan === selectedPlan);
                });
                confirmSlider.classList.toggle('three-year', selectedPlan === '3');
                
                // Update savings indicator
                if (selectedPlan === '3') {
                    confirmSavingsIndicator.textContent = "Saving 29%";
                    confirmSavingsIndicator.classList.add('activated');
                } else {
                    confirmSavingsIndicator.textContent = "Save 29%!";
                    confirmSavingsIndicator.classList.remove('activated');
                }
            }

            function validateStep(step) {
                if (step === 1) {
                    return activationCode && document.getElementById('activation-code').classList.contains('valid');
                }
                
                if (step === 2) {
                    return selectedPlan;
                }
                
                if (step === 3) {
                    const selectedOption = document.querySelector('.selection-option[data-type].selected');
                    if (!selectedOption) {
                        alert('Please select an account type.');
                        return false;
                    }
                    
                    const activeForm = isLoginMode ? 'existing-user-form' : 'new-user-form';
                    const form = document.getElementById(activeForm);
                    const inputs = form.querySelectorAll('input[required]');
                    
                    for (const input of inputs) {
                        if (!input.value.trim()) {
                            input.focus();
                            return false;
                        }
                    }
                    return true;
                }
                
                return true;
            }

            // Step navigation
            window.nextStep = async function() {
                if (!validateStep(currentStep)) return;
                
                const currentStepElement = document.getElementById(`step-${currentStep}`);
                const nextStepElement = document.getElementById(`step-${currentStep + 1}`);
                const currentIndicator = document.getElementById(`indicator-${currentStep}`);
                const nextIndicator = document.getElementById(`indicator-${currentStep + 1}`);
                
                // Special handling for step 3 (account validation)
                if (currentStep === 3) {
                    const continueButton = document.querySelector('#step-3 .btn-primary');
                    const originalHTML = continueButton.innerHTML;
                    
                    continueButton.disabled = true;
                    continueButton.innerHTML = '<div class="loading"><div class="spinner"></div> Validating...</div>';
                    
                    try {
                        if (isLoginMode) {
                            const email = document.getElementById('login-email').value;
                            const password = document.getElementById('login-password').value;

                            const success = await authenticateUser(email, password);
                            if (!success) {
                                showValidationError('existing-user-form', 'Invalid email or password. Please try again.');
                                continueButton.disabled = false;
                                continueButton.innerHTML = originalHTML;
                                return;
                            }
                        } else {
                            const email = document.getElementById('email').value;
                            const phone = document.getElementById('phone').value;

                            const response = await fetch('https://cabinpulse.com/api/users/check-availability', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    email,
                                    phone
                                })
                            });

                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }

                            const data = await response.json();
                            const { availability } = data;

                            let hasError = false;
                            clearValidationMessages('new-user-form');

                            if (!availability.email.available) {
                                showFieldError('email', availability.email.message);
                                hasError = true;
                            }

                            if (!availability.phone.available) {
                                showFieldError('phone', availability.phone.message);
                                hasError = true;
                            }

                            if (hasError) {
                                continueButton.disabled = false;
                                continueButton.innerHTML = originalHTML;
                                return;
                            }
                        }
                        
                    } catch (error) {
                        console.error('Validation error:', error);
                        showValidationError(isLoginMode ? 'existing-user-form' : 'new-user-form', 'An error occurred during validation. Please try again.');
                        continueButton.disabled = false;
                        continueButton.innerHTML = originalHTML;
                        return;
                    }
                    
                    continueButton.disabled = false;
                    continueButton.innerHTML = originalHTML;
                }
                
                if (currentStep === 3) {
                    updateConfirmationStep();
                }
                
                currentStepElement.classList.remove('active');
                currentIndicator.classList.remove('active');
                
                setTimeout(() => {
                    nextStepElement.classList.add('active');
                    nextIndicator.classList.add('active');
                    currentStep++;
                }, 300);
            };

            window.previousStep = function() {
                if (currentStep <= 1) return;
                
                const currentStepElement = document.getElementById(`step-${currentStep}`);
                const previousStepElement = document.getElementById(`step-${currentStep - 1}`);
                const currentIndicator = document.getElementById(`indicator-${currentStep}`);
                const previousIndicator = document.getElementById(`indicator-${currentStep - 1}`);
                
                currentStepElement.classList.remove('active');
                currentIndicator.classList.remove('active');
                
                setTimeout(() => {
                    previousStepElement.classList.add('active');
                    previousIndicator.classList.add('active');
                    currentStep--;
                }, 300);
            };

            // Form submission
            document.getElementById('activationForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitButton = document.getElementById('activation-button');
                const originalHTML = submitButton.innerHTML;
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="loading"><div class="spinner"></div> Processing...</div>';
                
                try {
                    const planData = plans[selectedPlan];
                    const totalAmount = planData.amount * 100; // Convert to cents
                    
                    let customerInfo;
                    if (isLoginMode) {
                        customerInfo = {
                            email: document.getElementById('login-email').value,
                            existingUser: true
                        };
                    } else {
                        customerInfo = {
                            email: document.getElementById('email').value,
                            phone: document.getElementById('phone').value,
                            name: document.getElementById('name').value,
                            existingUser: false
                        };
                    }
                    
                    const response = await fetch('https://cabinpulse.com/api/create-retail-activation-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            activationCode,
                            retailer: selectedRetailer,
                            planType: selectedPlan === '1' ? '1-year' : '3-year',
                            customerInfo: {
                                ...customerInfo,
                                name: customerInfo.name || undefined  // Include name for new users
                            },
                            userType: isLoginMode ? 'existing' : 'new',
                            deviceInfo,
                            priceData: {
                                planCost: planData.amount,
                                totalAmount
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to create checkout session');
                    }
                    
                    const { sessionId } = await response.json();
                    const stripe = Stripe('pk_live_51LZK81EVmyPNhExzHXm1BF3uC8BO6iTdg6R3hrrcjo3XEnq6fral763hSpQppYgCnRzNZO6zeCVHdq2aJ835k37e00Vhl33gOG');
                    
                    const { error } = await stripe.redirectToCheckout({
                        sessionId: sessionId
                    });
                    
                    if (error) {
                        console.error('Stripe Error:', error);
                        throw new Error(error.message);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message || 'An error occurred. Please try again.');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalHTML;
                }
            });

            // Add hover effect for touch devices
            if ('ontouchstart' in window) {
                retailerOptions.forEach(option => {
                    option.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.98)';
                    });
                    
                    option.addEventListener('touchend', function() {
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 100);
                    });
                });
            }
        });
    </script>
</body>
</html>